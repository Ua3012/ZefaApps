<!DOCTYPE html>
<html lang='uk'>
<head>
  <meta charset='UTF-8'>
  <meta name='viewport' content='width=device-width, initial-scale=1.0'>
  <title>Зєфаграм</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 600px;
      margin: 0 auto;
      padding: 0;
      background: url('zefagrambackground.png') no-repeat center center fixed;
      background-size: cover;
      display: flex;
      flex-direction: column;
      height: 100vh;
    }
    #auth, #chat {
      background: rgba(255, 255, 255, 0.9);
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.2);
      margin: auto;
      width: 90%;
      max-width: 500px;
    }
    input, button {
      padding: 10px;
      margin: 5px;
      border: 1px solid #ddd;
      border-radius: 6px;
      font-size: 16px;
    }
    button {
      background-color: #0084ff;
      color: white;
      border: none;
      cursor: pointer;
    }
    button:hover {
      background-color: #0066cc;
    }
    #messages {
      flex: 1;
      max-height: 60vh;
      overflow-y: auto;
      border-radius: 10px;
      padding: 10px;
      background-color: white;
      margin-bottom: 0;
    }
    .message {
      display: inline-block;
      clear: both;
      margin: 6px 0;
      padding: 10px;
      border-radius: 15px;
      max-width: 70%;
      word-wrap: break-word;
    }
    .message strong {
      color: #0084ff;
    }
    .from-me {
      background-color: #cfe9ff;
      float: right;
    }
    .from-others {
      background-color: #e9ecef;
      float: left;
    }
    #input-area {
      display: flex;
      border-top: 1px solid #ddd;
      padding: 10px;
      background: rgba(255,255,255,0.95);
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
    }
    #messageInput {
      flex: 1;
      border-radius: 20px;
      padding: 10px 15px;
      border: 1px solid #ccc;
      font-size: 16px;
    }
    #sendBtn {
      width: 50px;
      margin-left: 10px;
      border-radius: 50%;
      background-color: #0084ff;
      font-size: 20px;
    }
    #topbar {
      display: flex;
      justify-content: center;
      align-items: center;
      margin-bottom: 10px;
      position: relative;
    }
    .back, .logout {
      position: absolute;
      top: 0;
      padding: 8px 16px;
      border-radius: 20px;
      color: white;
      border: none;
      cursor: pointer;
    }
    .back {
      left: 10px;
      background-color: #555;
    }
    .back:hover {
      background-color: #333;
    }
    .logout {
      right: 10px;
      background-color: #f44336;
    }
    .logout:hover {
      background-color: #c0392b;
    }
  </style>
</head>
<body>
  <div id='auth'>
    <h2>Зєфаграм</h2>
    <input type='text' id='username' placeholder='Введіть свій юзєрнамє'>
    <input type='password' id='password' placeholder='Введіть пароль'>
    <button id='registerBtn'>Зарегаться</button>
    <button id='loginBtn'>Войти</button>
    <button class='back' onclick='location.href="index.html"'>⬅ Назад</button>
  </div>

  <div id='chat' style='display:none; flex-direction:column; height:100vh;'>
    <div id='topbar'>
      <button class='back' onclick='location.href="index.html"'>⬅ Назад</button>
      <h2 id='welcome'></h2>
      <button class='logout' id='logoutBtn'>Вийті</button>
    </div>
    <div id='messages'></div>
    <div id='input-area'>
      <input type='text' id='messageInput' placeholder='ПІШИ!!!'>
      <button id='sendBtn'>→</button>
    </div>
  </div>

  <script type='module'>
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/12.3.0/firebase-app.js'
    import { getDatabase, ref, set, push, get, child, onChildAdded } from 'https://www.gstatic.com/firebasejs/12.3.0/firebase-database.js'

    const firebaseConfig = {
      apiKey: 'AIzaSyBp_RXjmWLfK0wX8sDb1d_VQogZgwzaNFA',
      authDomain: 'zefagram.firebaseapp.com',
      databaseURL: 'https://zefagram-default-rtdb.europe-west1.firebasedatabase.app',
      projectId: 'zefagram',
      storageBucket: 'zefagram.firebasestorage.app',
      messagingSenderId: '664999563847',
      appId: '1:664999563847:web:3051100a05bdb41dc59762',
      measurementId: 'G-CFS89PSQNK'
    }

    const app = initializeApp(firebaseConfig)
    const db = getDatabase(app)
    let currentUser = localStorage.getItem('currentUser')

    const authDiv = document.getElementById('auth')
    const chatDiv = document.getElementById('chat')
    const usernameInput = document.getElementById('username')
    const passwordInput = document.getElementById('password')
    const messageInput = document.getElementById('messageInput')
    const messagesDiv = document.getElementById('messages')
    const welcome = document.getElementById('welcome')
    const registerBtn = document.getElementById('registerBtn')
    const loginBtn = document.getElementById('loginBtn')
    const sendBtn = document.getElementById('sendBtn')
    const logoutBtn = document.getElementById('logoutBtn')

    async function register() {
      const username = usernameInput.value.trim()
      const password = passwordInput.value.trim()
      if (!username || !password) return alert('Введи юзєрнамє і пароль!')
      const snapshot = await get(child(ref(db), 'users/' + username))
      if (snapshot.exists()) return alert('Такий юзер вже є!')
      await set(ref(db, 'users/' + username), { password })
      alert('Ти зарегався!')
    }

    async function login() {
      const username = usernameInput.value.trim()
      const password = passwordInput.value.trim()
      if (!username || !password) return alert('Введи юзєрнамє і пароль!')
      const snapshot = await get(child(ref(db), 'users/' + username))
      if (!snapshot.exists() || snapshot.val().password !== password) return alert('Неправильний юзєр або пароль!')
      currentUser = username
      localStorage.setItem('currentUser', username)
      authDiv.style.display = 'none'
      chatDiv.style.display = 'flex'
      welcome.textContent = username
    }

    function sendMessage() {
      const text = messageInput.value.trim()
      if (!text || !currentUser) return
      const time = new Date().toLocaleTimeString()
      push(ref(db, 'messages'), { user: currentUser, text, time })
      messageInput.value = ''
    }

    function addMessage(data) {
      const msg = data.val()
      const msgDiv = document.createElement('div')
      msgDiv.className = 'message ' + (msg.user === currentUser ? 'from-me' : 'from-others')
      msgDiv.innerHTML = '<strong>' + msg.user + '</strong>: ' + msg.text + ' <small>(' + msg.time + ')</small>'
      messagesDiv.appendChild(msgDiv)
      messagesDiv.scrollTop = messagesDiv.scrollHeight
    }

    onChildAdded(ref(db, 'messages'), addMessage)

    function logout() {
      localStorage.removeItem('currentUser')
      currentUser = null
      chatDiv.style.display = 'none'
      authDiv.style.display = 'block'
    }

    registerBtn.onclick = register
    loginBtn.onclick = login
    sendBtn.onclick = sendMessage
    logoutBtn.onclick = logout

    usernameInput.addEventListener('keypress', e => { if (e.key === 'Enter') login() })
    messageInput.addEventListener('keypress', e => { if (e.key === 'Enter') sendMessage() })

    if (currentUser) {
      authDiv.style.display = 'none'
      chatDiv.style.display = 'flex'
      welcome.textContent = currentUser
    }
  </script>
</body>
</html>
