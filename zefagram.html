<!DOCTYPE html>
<html lang='uk'>
<head>
<meta charset='UTF-8'>
<meta name='viewport' content='width=device-width, initial-scale=1.0'>
<title>–ó—î—Ñ–∞–≥—Ä–∞–º</title>
<style>
@font-face{font-family:'Minecraft';src:url('minecraft-mojangles.otf') format('opentype');}
body{margin:0;font-family:Arial,sans-serif;background:url('zefagrambackground.png') center/cover no-repeat;display:flex;flex-direction:column;height:100vh;}
.screen{display:none;flex-direction:column;align-items:center;width:100%;max-width:600px;margin:auto;background:rgba(255,255,255,0.95);border-radius:12px;padding:15px;box-shadow:0 2px 6px rgba(0,0,0,0.2);height:95vh;}
h2{text-align:center;margin:10px 0;}
input,button{padding:10px;margin:5px;border-radius:6px;border:1px solid #ccc;font-size:16px;}
button{cursor:pointer;background:#0084ff;color:white;border:none;}
button:hover{background:#0066cc;}
.topbar{width:100%;display:flex;justify-content:center;align-items:center;position:relative;margin-bottom:10px;}
.back{padding:8px 16px;border-radius:20px;color:white;border:none;cursor:pointer;background:#555;}
.back:hover{background:#333;}
#messages{flex:1;width:100%;overflow-y:auto;background:rgba(255,255,255,0.8);border-radius:10px;padding:10px;margin-bottom:0;}
.message{display:inline-block;clear:both;margin:6px 0;padding:10px;border-radius:15px;max-width:70%;word-wrap:break-word;font-family:'Minecraft',Arial;position:relative;}
.message strong{color:#0084ff;}
.from-me{background:#cfe9ff;float:right;}
.from-others{background:#e9ecef;float:left;}
#audioMsg{width:100%;margin-top:5px;}
#input-area{display:flex;width:100%;border-top:1px solid #ddd;padding:10px;background:rgba(255,255,255,0.95);}
#messageInput{flex:1;border-radius:20px;padding:10px 15px;border:1px solid #ccc;font-size:16px;}
#sendBtn{width:50px;margin-left:10px;border-radius:50%;font-size:20px;}
#voiceMsgBtn{margin-left:5px;font-size:20px;border-radius:50%;background:#0084ff;width:40px;height:40px;padding:0;display:flex;align-items:center;justify-content:center;}
#voiceMsgBtn.active{background:green;}
.emojiPicker{display:flex;gap:5px;margin-top:5px;flex-wrap:wrap;justify-content:center;}
.emojiPicker img{width:40px;height:40px;cursor:pointer;}
.menuBtn{padding:10px 15px;width:90%;margin:5px;text-align:center;border-radius:12px;background:#0084ff;color:white;}
.menuBtn:hover{background:#0066cc;}
#menuGreetingWrapper{display:flex;flex-direction:column;align-items:center;margin-bottom:10px;}
#menuGreeting{margin-bottom:10px;}
.menuActions{display:flex;gap:10px;margin-top:10px;justify-content:center;}
.privateChatLink{display: block; width: 90%; padding: 10px; margin: 5px; text-align: center; border-radius: 6px; background: #e0e0e0; color: #333; cursor: pointer; border: 1px solid #ccc; position: relative;}
.privateChatLink:hover{background: #d0d0d0;}
.unread-badge{position: absolute; right: 10px; top: 50%; transform: translateY(-50%); background: red; color: white; border-radius: 50%; padding: 3px 8px; font-size: 12px; font-weight: bold;}
@media(max-width:500px){.screen{width:95%;padding:10px;}#input-area{padding:5px;}#messageInput{font-size:14px;padding:8px;}}
</style>
</head>
<body>

<div id='authScreen' class='screen'>
<h2>–ó—î—Ñ–∞–≥—Ä–∞–º</h2>
<input type='text' id='username' placeholder='–í–≤–µ–¥—ñ—Ç—å —é–∑—î—Ä–Ω–∞–º—î'>
<input type='password' id='password' placeholder='–ü–∞—Ä–æ–ª—å'>
<button id='registerBtn'>–ó–∞—Ä–µ–≥–∞—Ç—å—Å—è</button>
<button id='loginBtn'>–í–≤—ñ–π—Ç—ñ</button>
<button id='backAuth' class='back'>‚¨Ö –ù–∞–∑–∞–¥</button>
</div>

<div id='menuScreen' class='screen'>
<div id='menuGreetingWrapper'>
<h2 id='menuGreeting'></h2>
</div>
<button class='menuBtn' id='publicChatBtn'>–û–±—â—ñ–π —á–∞—Ç <span id='publicUnread' class='unread-badge' style='display:none;'></span></button>
<button class='menuBtn' id='privateChatsBtn'>–ü—Ä—ñ–≤–∞—Ç–Ω—ñ —á–∞—Ç–∏</button>
<button class='menuBtn' id='createPrivateBtn'>–°—Ç–≤–æ—Ä–∏—Ç–∏ –ø—Ä—ñ–≤–∞—Ç–Ω–∏–π —á–∞—Ç</button>
<div class='menuActions'>
<button id='logoutMenu' class='back'>–í–∏–π—Ç—ñ</button>
<button id='backMenu' class='back'>‚¨Ö –ù–∞–∑–∞–¥ –¥–æ –º–µ–Ω—é</button>
</div>
</div>

<div id='chatScreen' class='screen'>
<div class='topbar'>
<h2 id='chatTitle'></h2>
</div>
<div id='messages'></div>
<div id='input-area'>
<input type='text' id='messageInput' placeholder='–ü–Ü–®–ò!!!'>
<button id='sendBtn'>‚Üí</button>
<button id='voiceMsgBtn'>üéôÔ∏è</button>
</div>
<div class='emojiPicker' id='emojiPicker'>
<img src='zefasticker1.png'>
<img src='zefasticker2.png'>
<img src='zefasticker3.png'>
<img src='zefasticker4.png'>
<img src='zefasticker5.png'>
<img src='zefasticker6.png'>
<img src='zefasticker7.png'>
</div>
<div class='menuActions'>
<button id='backChat' class='back'>‚¨Ö –ù–∞–∑–∞–¥</button>
</div>
</div>

<div id='privateChatsScreen' class='screen' style='display:none;'>
¬† ¬† <h2>–ü—Ä—ñ–≤–∞—Ç–Ω—ñ —á–∞—Ç–∏</h2>
¬† ¬† <div id='privateChatsList' style='width:100%; flex: 1; overflow-y: auto;'></div>
¬† ¬† <div class='menuActions'>
¬† ¬† ¬† ¬† <button id='backPrivateChats' class='back'>‚¨Ö –ù–∞–∑–∞–¥</button>
¬† ¬† </div>
</div>

<script type='module'>
import { initializeApp } from 'https://www.gstatic.com/firebasejs/12.3.0/firebase-app.js'
import { getDatabase, ref, set, push, get, child, onValue, update, remove } from 'https://www.gstatic.com/firebasejs/12.3.0/firebase-database.js'

const firebaseConfig={apiKey:'AIzaSyBp_RXjmWLfK0wX8sDb1d_VQogZgwzaNFA',authDomain:'zefagram.firebaseapp.com',databaseURL:'https://zefagram-default-rtdb.europe-west1.firebasedatabase.app',projectId:'zefagram',storageBucket:'zefagram.firebasestorage.app',messagingSenderId:'664999563847',appId:'1:664999563847:web:3051100a05bdb41dc59762',measurementId:'G-CFS89PSQNK'}
const app=initializeApp(firebaseConfig)
const db=getDatabase(app)
let currentUser=localStorage.getItem('currentUser')||null
let currentChat='public'
let peerConnections={},localStream=null,callRefs={}
let publicChatUnreadListener = null; 

const authScreen=document.getElementById('authScreen')
const menuScreen=document.getElementById('menuScreen')
const chatScreen=document.getElementById('chatScreen')
const privateChatsScreen=document.getElementById('privateChatsScreen')
const usernameInput=document.getElementById('username')
const passwordInput=document.getElementById('password')
const messagesDiv=document.getElementById('messages')
const chatTitle=document.getElementById('chatTitle')
const messageInput=document.getElementById('messageInput')
const menuGreeting=document.getElementById('menuGreeting')
const privateChatsList=document.getElementById('privateChatsList')
const publicUnreadBadge = document.getElementById('publicUnread');

function formatTime(date){return date.getFullYear()+'-'+(date.getMonth()+1)+'-'+date.getDate()+' '+date.getHours()+':'+String(date.getMinutes()).padStart(2,'0')}

async function register(){const u=usernameInput.value.trim();const p=passwordInput.value.trim();if(!u||!p)return alert('–í–≤—î–¥–∏—ñ —é–∑—î—Ä–Ω–∞–º—î —ñ –ø–∞—Ä–æ–ª—å');const s=await get(child(ref(db),'users/'+u));if(s.exists())return alert('–¢–∞–∫–∏–π —é–∑—î—Ä –≤–∂–µ —î');await set(ref(db,'users/'+u),{password:p, chats: {}, lastRead: {public: 0}});alert('–¢–∏ –∑–∞—Ä–µ–≥–∞–≤—Å—è!')}
async function login(){const u=usernameInput.value.trim();const p=passwordInput.value.trim();if(!u||!p)return alert('–í–≤—î–¥—ñ —é–∑—î—Ä–Ω–∞–º—î —ñ –ø–∞—Ä–æ–ª—å');const s=await get(child(ref(db),'users/'+u));if(!s.exists()||s.val().password!==p)return alert('–ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–∏–π —é–∑—î—Ä —ñ–ª—ñ –ø–∞—Ä–æ–ª—å');currentUser=u;localStorage.setItem('currentUser',u);showMenu(true)}

function showMenu(show){
    authScreen.style.display='none';
    menuScreen.style.display=show?'flex':'none';
    chatScreen.style.display='none';
    privateChatsScreen.style.display='none';
    if(show){
        menuGreeting.textContent=`–ü—Ä—ñ–≤—î—Ç, –¥—É—Ä–∞ ${currentUser}!`;
        updateUnreadCount();
    }
}

function getChatPath(chatId = currentChat){
    return chatId === '–û–±—â—ñ–π —á–∞—Ç' ? 'messages/public' : 'messages/' + chatId
}

function renderMessage(msgSnapshot, totalMessages){
    const msg = msgSnapshot.val();
    const messageKey = msgSnapshot.key;
    const messageIndex = totalMessages;
    
    const d=document.createElement('div');
    d.className='message '+(msg.user===currentUser?'from-me':'from-others');
    let text=msg.text;
    if(msg.type==='sticker')text=`<img src='${msg.url}' style='width:50px;height:50px'>`;
    else if(msg.type==='audio')text=`<audio controls src='${msg.url}'></audio>`;
    else text=text.replace(/\*\*(.*?)\*\*/g,'<b>$1</b>').replace(/\*(.*?)\*/g,'<i>$1</i>').replace(/__(.*?)__/g,'<u>$1</u>').replace(/~~(.*?)~~/g,'<s>$1</s>').replace(/`(.*?)`/g,"<span style='font-family:monospace'>$1</span>");
    
    d.innerHTML=`<strong>${msg.user}</strong>: ${text} <small>(${msg.time})</small>`;
    
    if (msg.user === currentUser) {
        d.ondblclick = () => deleteMessage(messageKey, msg.type);
    }
    
    d.setAttribute('data-index', messageIndex); 
    messagesDiv.appendChild(d);
    messagesDiv.scrollTop=messagesDiv.scrollHeight
}

async function deleteMessage(messageKey, type) {
    if (!currentUser) return;
    if (confirm('–£–¥–∞–ª—ñ—Ç—å? –Ñ—Å–ª—ñ —Ç–∏ –µ—Ç–∞ –∑—Ä–æ–±–∏—à, —Ç–æ –ó—î—Ñ–∞–ë–æ—Ç –≤—Å–µ –æ–¥–Ω–æ –±—É–¥—ñ—Ç –ø—Ä–∞–≤—ñ—Ç—å –º—ñ—Ä–∞–º!')) {
        const chatPath = getChatPath();
        await remove(ref(db, chatPath + '/' + messageKey));
    }
}

async function markChatAsRead(chatId, lastMessageIndex) {
    if (!currentUser || lastMessageIndex === 0) return; 

    if (chatId === '–û–±—â—ñ–π —á–∞—Ç') {
        const publicReadRef = ref(db, 'users/' + currentUser + '/lastRead/public');
        await set(publicReadRef, lastMessageIndex);
    } else {
        const privateReadRef = ref(db, 'users/' + currentUser + '/chats/' + chatId + '/lastRead');
        await set(privateReadRef, lastMessageIndex);
    }
}

function showChat(chat, partner=null){
    currentChat=chat;
    messagesDiv.innerHTML='';
    authScreen.style.display='none';
    menuScreen.style.display='none';
    chatScreen.style.display='flex';
    privateChatsScreen.style.display='none';
    chatTitle.textContent=partner || chat;
    
    if (publicChatUnreadListener) {
        publicChatUnreadListener(); 
        publicChatUnreadListener = null;
    }
    
    const chatRef=ref(db, getChatPath());
    onValue(chatRef,snapshot=>{
        messagesDiv.innerHTML='';
        let totalMessages = 0;
        snapshot.forEach(c=>{
            totalMessages++;
            renderMessage(c, totalMessages);
        });
        markChatAsRead(currentChat, totalMessages); 
    });
}

function logout(){localStorage.removeItem('currentUser');currentUser=null;authScreen.style.display='flex';menuScreen.style.display='none';chatScreen.style.display='none';privateChatsScreen.style.display='none'}

async function sendMessage(){
    const t=messageInput.value.trim();
    if(!t||!currentUser)return;
    
    push(ref(db, getChatPath()),{user:currentUser,text:t,time:formatTime(new Date()),type:'text'});
    messageInput.value='';
}

async function sendSticker(url){
    push(ref(db, getChatPath()),{user:currentUser,url,type:'sticker',time:formatTime(new Date())})
}

async function sendAudio(blob){
    const chatPath = getChatPath();
    
    const CLOUDINARY_CLOUD_NAME = 'doylfteu4';
    const CLOUDINARY_UPLOAD_PRESET = 'zefagram_audio';

    const formData = new FormData();
    formData.append('file', blob, 'audio.webm');
    formData.append('upload_preset', CLOUDINARY_UPLOAD_PRESET);
    
    let url = '';

    try {
        const response = await fetch(
            `https://api.cloudinary.com/v1_1/${CLOUDINARY_CLOUD_NAME}/upload`,
            {
                method: 'POST',
                body: formData
            }
        );
        const data = await response.json();
        if (data.secure_url) {
            url = data.secure_url;
        } else {
            console.error('Cloudinary Response:', data);
            throw new Error('–ê—à–∏–±–∫–∞, –ø—ñ—à–∏ Ua3012dima30: ' + (data.error ? data.error.message : '–®–æ?'));
        }
    } catch(e) {
        alert('–õ–æ—Ö, –µ—Ç–∞ –∑–Ω–∞—á—ñ—Ç —à–æ –Ω—É–∂–∏–Ω –Ω–æ—Ä–º —ñ–Ω–µ—Ç: ' + e.message);
        return;
    }

    push(ref(db, chatPath),{user:currentUser,url,type:'audio',time:formatTime(new Date())});
}

async function updateUnreadCount() {
    if (!currentUser) return;

    // Public Chat Unread
    const publicChatRef = ref(db, 'messages/public');
    publicChatUnreadListener = onValue(publicChatRef, async (publicSnapshot) => {
        let totalMessages = publicSnapshot.size;
        const lastReadSnap = await get(child(ref(db), 'users/' + currentUser + '/lastRead/public'));
        const lastRead = lastReadSnap.exists() ? lastReadSnap.val() : 0;
        const unreadCount = totalMessages > lastRead ? totalMessages - lastRead : 0;

        if (unreadCount > 0) {
            publicUnreadBadge.textContent = unreadCount;
            publicUnreadBadge.style.display = 'inline';
            notifyZefaBot('–û–±—â—ñ–π —á–∞—Ç', unreadCount); 
        } else {
            publicUnreadBadge.style.display = 'none';
        }
    });
}

async function notifyZefaBot(chatName, unreadCount) {
    if (unreadCount === 0) return;
    
    const notificationRef = ref(db, 'notifications/' + currentUser);
    const lastNotificationSnap = await get(notificationRef);
    const lastNotificationTime = lastNotificationSnap.exists() ? lastNotificationSnap.val().time : 0;
    const currentTime = Date.now();
    
    // –©–æ–± –Ω–µ —Å–ø–∞–º–∏—Ç–∏ –±–æ—Ç–∞, –≤—ñ–¥–ø—Ä–∞–≤–ª—è—î–º–æ –Ω–µ —á–∞—Å—Ç—ñ—à–µ –Ω—ñ–∂ —Ä–∞–∑ –Ω–∞ 10 —Å–µ–∫—É–Ω–¥
    if (currentTime - lastNotificationTime < 10000) {
        return; 
    }

    let partner = null;
    let type = 'public';

    if (chatName !== '–û–±—â—ñ–π —á–∞—Ç') {
        const userChatsRef = ref(db, 'users/' + currentUser + '/chats');
        const userChatsSnap = await get(userChatsRef);
        const chats = userChatsSnap.val();
        for (const chatID in chats) {
            if (chatID === chatName) {
                partner = chats[chatID].partner;
                type = 'private';
                break;
            }
        }
    }

    const payload = {
        user: currentUser,
        chatName: chatName,
        partner: partner,
        type: type,
        unreadCount: unreadCount,
        time: currentTime
    };
    
    // –ù–∞–¥—Å–∏–ª–∞—î–º–æ —Å–ø–æ–≤—ñ—â–µ–Ω–Ω—è –≤ –±–∞–∑—É, —è–∫–µ –ó—î—Ñ–∞–ë–æ—Ç –ø—Ä–æ—á–∏—Ç–∞—î
    await set(notificationRef, payload);
}


async function showPrivateChats() {
    if (!currentUser) return;
    showScreen('privateChatsScreen');
    
    const userChatsRef = ref(db, 'users/' + currentUser + '/chats');
    onValue(userChatsRef, async (snapshot) => {
        privateChatsList.innerHTML = '';
        if (snapshot.exists()) {
            const chats = snapshot.val();
            for (const chatID in chats) {
                const partner = chats[chatID].partner;
                const lastRead = chats[chatID].lastRead || 0;
                
                const chatMessagesRef = ref(db, getChatPath(chatID));
                const messagesSnap = await get(chatMessagesRef);
                const totalMessages = messagesSnap.size;
                const unreadCount = totalMessages > lastRead ? totalMessages - lastRead : 0;
                
                if (unreadCount > 0) {
                    notifyZefaBot(chatID, unreadCount); 
                }
                
                const d = document.createElement('button');
                d.className = 'privateChatLink';
                d.textContent = `–ë–∞–∑–∞—Ä –∑: ${partner}`;
                d.onclick = () => showChat(chatID, partner);
                
                if (unreadCount > 0) {
                    const badge = document.createElement('span');
                    badge.className = 'unread-badge';
                    badge.textContent = unreadCount;
                    d.appendChild(badge);
                }
                
                privateChatsList.appendChild(d);
            }
        } else {
            privateChatsList.innerHTML = '<p style=\'text-align: center; margin-top: 20px;\'>–ü—É—Å—Ç–∞.</p>';
        }
    });
}

async function createPrivateChat() {
    const partner = prompt('–í–≤—î–¥—ñ—Ç—î —é–∑—î—Ä–Ω–∞–º—î —Å–ø—ñ–≤—Ä–æ–∑–º–æ–≤–Ω–∏–∫–∞:');
    if (!partner || partner === currentUser) return alert('–ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–∏–π —é–∑—î—Ä–Ω–∞–º—î.');
    
    const partnerSnap = await get(child(ref(db), 'users/' + partner));
    if (!partnerSnap.exists()) return alert('–¢–∞–∫–æ–≤–∞ –Ω–µ–º–∞!.');
    
    const chatUsers = [currentUser, partner].sort();
    const chatID = 'private_' + chatUsers[0] + '_' + chatUsers[1];
    
    const updates = {};
    updates['/users/' + currentUser + '/chats/' + chatID] = { partner: partner, lastRead: 0 }; 
    updates['/users/' + partner + '/chats/' + chatID] = { partner: currentUser, lastRead: 0 }; 

    await update(ref(db), updates);
    alert(`–°—Ç–≤–æ—Ä–µ–Ω–æ –±–∞–∑–∞—Ä –∑ ${partner}!`);
    showChat(chatID, partner);
}

function showScreen(screenId) {
    const screens = [authScreen, menuScreen, chatScreen, privateChatsScreen];
    screens.forEach(screen => {
        screen.style.display = (screen.id === screenId) ? 'flex' : 'none';
    });
}

document.querySelectorAll('#emojiPicker img').forEach(i=>i.onclick=e=>sendSticker(e.target.src))

document.getElementById('registerBtn').onclick=register
document.getElementById('loginBtn').onclick=login
document.getElementById('backMenu').onclick=()=>window.location.href='https://ua3012.github.io/ZefaApps/index.html'
document.getElementById('logoutMenu').onclick=logout
document.getElementById('backChat').onclick=()=>{
    if (publicChatUnreadListener) {
        publicChatUnreadListener(); 
        publicChatUnreadListener = null;
    }
    showMenu(true);
}
document.getElementById('backAuth').onclick=()=>window.location.href='https://ua3012.github.io/ZefaApps/index.html'
document.getElementById('publicChatBtn').onclick=()=>showChat('–û–±—â—ñ–π —á–∞—Ç')
document.getElementById('sendBtn').onclick=sendMessage

document.getElementById('privateChatsBtn').onclick=showPrivateChats;
document.getElementById('createPrivateBtn').onclick=createPrivateChat;
document.getElementById('backPrivateChats').onclick=()=>showMenu(true);


let mediaRecorder
let mediaStream = null;

document.getElementById('voiceMsgBtn').onclick=async()=>{
    if(!currentUser) return alert('–í–≤–∞–π–¥—ñ, —à–æ–± –±–∞–∑–∞—Ä—ñ—Ç—å!');

    const voiceBtnElement = document.getElementById('voiceMsgBtn');

    if(mediaRecorder && mediaRecorder.state === 'recording'){
        mediaRecorder.stop();
        voiceBtnElement.classList.remove('active');
        return
    }

    try {
        if (!mediaStream) {
            mediaStream = await navigator.mediaDevices.getUserMedia({audio:true});
        }
        
        mediaRecorder = new MediaRecorder(mediaStream);
        voiceBtnElement.classList.add('active');
        
        let chunks=[]
        mediaRecorder.ondataavailable=e=>chunks.push(e.data)
        
        mediaRecorder.onstop=e=>{
            if (mediaStream) {
                mediaStream.getTracks().forEach(track => track.stop());
                mediaStream = null;
            }
            if(chunks.length > 0) sendAudio(new Blob(chunks,{type:'audio/webm'}));
        }
        
        mediaRecorder.start();
    } catch(e) {
        alert('–®–æ –∑ –º—ñ–∫–æ–º: ' + e.message)
        voiceBtnElement.classList.remove('active');
    }
}

window.onload=()=>{if(currentUser){showMenu(true); updateUnreadCount();}else authScreen.style.display='flex'}
</script>
</body>
</html>
