<!DOCTYPE html>
<html lang='uk'>
<head>
<meta charset='UTF-8'>
<meta name='viewport' content='width=device-width, initial-scale=1.0'>
<title>–ó—î—Ñ–∞–≥—Ä–∞–º</title>
<style>
@font-face{font-family:'Minecraft';src:url('minecraft-mojangles.otf') format('opentype');}
body{
    margin: 0;
    font-family: Arial, sans-serif;
    background: url('zefagrambackground.png') center/cover no-repeat;
    display: flex;
    flex-direction: column;
    min-height: 100vh; 
    align-items: center; 
    justify-content: center;
}
.screen{
    display: none;
    flex-direction: column;
    align-items: center;
    width: 100%;
    max-width: 600px;
    margin: 20px auto;
    background: rgba(255,255,255,0.95);
    border-radius: 12px;
    padding: 15px;
    box-shadow: 0 2px 6px rgba(0,0,0,0.2);
    min-height: 80vh; 
    flex-grow: 1; 
    box-sizing: border-box;
}
h2{text-align:center;margin:10px 0;}
input,button{padding:10px;margin:5px;border-radius:6px;border:1px solid #ccc;font-size:16px;box-sizing: border-box;}
button{cursor:pointer;background:#0084ff;color:white;border:none;}
button:hover{background:#0066cc;}
.topbar{width:100%;display:flex;justify-content:space-between;align-items:center;position:relative;margin-bottom:10px;}
.back{padding:8px 16px;border-radius:20px;color:white;border:none;cursor:pointer;background:#555;}
.back:hover{background:#333;}
#messages{
    flex: 1;
    width: 100%;
    overflow-y: auto;
    background: rgba(255,255,255,0.8);
    border-radius: 10px;
    padding: 10px;
    margin-bottom: 10px;
}
.message{display:inline-block;clear:both;margin:6px 0;padding:10px;border-radius:15px;max-width:70%;word-wrap:break-word;font-family:'Minecraft',Arial;}
.message strong{color:#0084ff;}
.from-me{background:#cfe9ff;float:right;}
.from-others{background:#e9ecef;float:left;}
#audioMsg{width:100%;margin-top:5px;}
#input-area{
    display:flex;
    width:100%;
    border-top:1px solid #ddd;
    padding:10px 0;
    background:transparent;
    align-items: center;
}
#messageInput{flex:1;border-radius:20px;padding:10px 15px;border:1px solid #ccc;font-size:16px;}
#sendBtn{width:50px;min-width:50px;margin-left:10px;border-radius:50%;font-size:20px;padding:0;}
#voiceMsgBtn,#micToggleBtn{
    width: 50px;
    height: 50px;
    margin-left:5px;
    font-size:20px;
    border-radius:50%;
    background:#0084ff;
    padding: 0;
}
#voiceMsgBtn.active,#micToggleBtn.active{background:green;}
#formatBtn{margin-right:5px;width:50px;height:50px;padding:0;font-weight:bold;}
.formatMenu{
    display:none;
    flex-direction:row;
    background:#eee;
    padding:5px;
    border-radius:8px;
    position:absolute;
    bottom: 65px;
    left: 10px;
    z-index:10;
    box-shadow: 0 1px 4px rgba(0,0,0,0.2);
}
.formatMenu button{margin:2px;padding: 5px 10px;font-weight: bold;}
.emojiPicker{
    display:flex;
    gap:5px;
    margin-top:5px;
    flex-wrap:wrap;
    justify-content:center;
    padding: 5px 0;
}
.emojiPicker img{width:40px;height:40px;cursor:pointer;}
.menuBtn{padding:10px 15px;width:90%;margin:5px;text-align:center;border-radius:12px;background:#0084ff;color:white;}
.menuBtn:hover{background:#0066cc;}
#menuGreetingWrapper{display:flex;flex-direction:column;align-items:center;margin-bottom:20px;}
#menuGreeting{margin-bottom:10px;}
.menuActions{width: 100%; display:flex;gap:10px;margin-top:auto;justify-content:space-around;padding-top: 10px; border-top: 1px solid #ddd;}
.callBtn{padding:5px 10px;background:green;color:white;border-radius:6px;margin-left:10px;}
@media(max-width:500px){.screen{width:95%;padding:10px;}#input-area{padding:5px;}#messageInput{font-size:14px;padding:8px;}}
</style>
</head>
<body>

<div id='authScreen' class='screen'>
<h2>–ó—î—Ñ–∞–≥—Ä–∞–º</h2>
<input type='text' id='username' placeholder='–í–≤–µ–¥—ñ—Ç—å —é–∑—î—Ä–Ω–∞–º—î'>
<input type='password' id='password' placeholder='–ü–∞—Ä–æ–ª—å'>
<button id='registerBtn'>–ó–∞—Ä–µ–≥–∞—Ç—å—Å—è</button>
<button id='loginBtn'>–í–æ–π—Ç–∏</button>
<button id='backAuth' class='back' style='margin-top: auto;'>‚¨Ö –ù–∞–∑–∞–¥ –¥–æ Zefa Apps</button>
</div>

<div id='menuScreen' class='screen'>
<div id='menuGreetingWrapper'>
<h2 id='menuGreeting'></h2>
</div>
<button class='menuBtn' id='publicChatBtn'>–°–ø—ñ–ª—å–Ω–∏–π —á–∞—Ç</button>
<button class='menuBtn' id='publicVoiceBtn'>–°–ø—ñ–ª—å–Ω–∏–π –≥–æ–ª–æ—Å–æ–≤–∏–π —á–∞—Ç</button>
<button class='menuBtn' id='privateChatsBtn'>–ü—Ä–∏–≤–∞—Ç–Ω—ñ —á–∞—Ç–∏</button>
<button class='menuBtn' id='createPrivateBtn'>–°—Ç–≤–æ—Ä–∏—Ç–∏ –ø—Ä–∏–≤–∞—Ç–Ω–∏–π —á–∞—Ç</button>
<div class='menuActions'>
<button id='logoutMenu' class='back'>–í–∏–π—Ç—ñ</button>
<button id='backMenu' class='back'>‚¨Ö –ù–∞–∑–∞–¥ –¥–æ Zefa Apps</button>
</div>
</div>

<div id='chatScreen' class='screen'>
<div class='topbar'>
<button id='backChat' class='back'>‚¨Ö –ù–∞–∑–∞–¥</button>
<h2 id='chatTitle'></h2>
<button class='callBtn' id='callBtn' style='display:none;'>üìû –î–∑–≤—ñ–Ω–æ–∫</button>
</div>
<div id='messages'></div>
<div id='input-area'>
<div style='position:relative;'>
    <button id='formatBtn'>‚Ä¶</button>
    <div class='formatMenu' id='formatMenu'>
        <button data-format='**'>B</button>
        <button data-format='*'>I</button>
        <button data-format='__'>U</button>
        <button data-format='~~'>S</button>
        <button data-format='`'>MONO</button>
    </div>
</div>
<input type='text' id='messageInput' placeholder='–ü–Ü–®–ò!!!'>
<button id='sendBtn'>‚Üí</button>
<button id='voiceMsgBtn'>üéôÔ∏è</button>
</div>
<div class='emojiPicker' id='emojiPicker'>
<img src='zefasticker1.png'>
<img src='zefasticker2.png'>
<img src='zefasticker3.png'>
<img src='zefasticker4.png'>
<img src='zefasticker5.png'>
</div>
</div>

<div id='voiceScreen' class='screen'>
<div class='topbar'>
<h2 id='voiceTitle'>–°–ø—ñ–ª—å–Ω–∏–π –≥–æ–ª–æ—Å–æ–≤–∏–π —á–∞—Ç</h2>
</div>
<button id='micToggleBtn' style='font-size:40px;padding:30px;border-radius:50%;'>üéôÔ∏è</button>
<div id='voiceUsers'></div>
<div class='menuActions'>
<button id='backVoice' class='back'>‚¨Ö –ù–∞–∑–∞–¥</button>
</div>
</div>

<script type='module'>
import { initializeApp } from 'https://www.gstatic.com/firebasejs/12.3.0/firebase-app.js'
import { getDatabase, ref, set, push, get, child, onValue } from 'https://www.gstatic.com/firebasejs/12.3.0/firebase-database.js'
import { getStorage, ref as sRef, uploadBytes, getDownloadURL } from 'https://www.gstatic.com/firebasejs/12.3.0/firebase-storage.js'

const firebaseConfig={apiKey:'AIzaSyBp_RXjmWLfK0wX8sDb1d_VQogZgwzaNFA',authDomain:'zefagram.firebaseapp.com',databaseURL:'https://zefagram-default-rtdb.europe-west1.firebasedatabase.app',projectId:'zefagram',storageBucket:'zefagram.firebasestorage.app',messagingSenderId:'664999563847',appId:'1:664999563847:web:3051100a05bdb41dc59762',measurementId:'G-CFS89PSQNK'}
const app=initializeApp(firebaseConfig)
const db=getDatabase(app)
const storage=getStorage(app)
let currentUser=localStorage.getItem('currentUser')||null
let currentChat='public'
let peerConnections={},localStream=null,callRefs={}

const authScreen=document.getElementById('authScreen')
const menuScreen=document.getElementById('menuScreen')
const chatScreen=document.getElementById('chatScreen')
const voiceScreen=document.getElementById('voiceScreen')
const usernameInput=document.getElementById('username')
const passwordInput=document.getElementById('password')
const messagesDiv=document.getElementById('messages')
const chatTitle=document.getElementById('chatTitle')
const messageInput=document.getElementById('messageInput')
const menuGreeting=document.getElementById('menuGreeting')
const formatMenu=document.getElementById('formatMenu')
const formatBtn=document.getElementById('formatBtn')
const voiceMsgBtn=document.getElementById('voiceMsgBtn')
const micToggleBtn=document.getElementById('micToggleBtn')
const voiceUsersDiv=document.getElementById('voiceUsers')

function formatTime(date){return date.getFullYear()+'-'+(date.getMonth()+1)+'-'+date.getDate()+' '+date.getHours()+':'+String(date.getMinutes()).padStart(2,'0')}

async function register(){const u=usernameInput.value.trim();const p=passwordInput.value.trim();if(!u||!p)return alert('–í–≤–µ–¥–∏ —é–∑—î—Ä–Ω–∞–º—î —ñ –ø–∞—Ä–æ–ª—å');const s=await get(child(ref(db),'users/'+u));if(s.exists())return alert('–¢–∞–∫–∏–π —é–∑–µ—Ä –≤–∂–µ —î');await set(ref(db,'users/'+u),{password:p});alert('–¢–∏ –∑–∞—Ä–µ–≥–∞–≤—Å—è!');login()}
async function login(){const u=usernameInput.value.trim();const p=passwordInput.value.trim();if(!u||!p)return alert('–í–≤–µ–¥–∏ —é–∑—î—Ä–Ω–∞–º—î —ñ –ø–∞—Ä–æ–ª—å');const s=await get(child(ref(db),'users/'+u));if(!s.exists()||s.val().password!==p)return alert('–ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–∏–π —é–∑–µ—Ä –∞–±–æ –ø–∞—Ä–æ–ª—å');currentUser=u;localStorage.setItem('currentUser',u);showMenu(true)}

function showScreen(screenId) {
    authScreen.style.display = 'none';
    menuScreen.style.display = 'none';
    chatScreen.style.display = 'none';
    voiceScreen.style.display = 'none';
    document.getElementById(screenId).style.display = 'flex';
}

function showMenu(show){
    if(show) {
        showScreen('menuScreen');
        menuGreeting.textContent=`–ü—Ä—ñ–≤—î—Ç, –¥—É—Ä–∞ ${currentUser}!`;
    } else {
        showScreen('authScreen');
    }
}

function renderMessage(msg){
    const d=document.createElement('div');
    d.className='message '+(msg.user===currentUser?'from-me':'from-others');
    let text=msg.text;
    if(msg.type==='sticker')text=`<img src='${msg.url}' style='width:50px;height:50px'>`;
    if(msg.type==='audio')text=`<audio controls src='${msg.url}'></audio>`;
    
    text = text.replace(/\*\*(.*?)\*\*/g,'<b>$1</b>');
    text = text.replace(/\*(.*?)\*/g,'<i>$1</i>');
    text = text.replace(/__(.*?)__/g,'<u>$1</u>');
    text = text.replace(/~~(.*?)~~/g,'<s>$1</s>');
    text = text.replace(/`(.*?)`/g,"<span style='font-family:monospace'>$1</span>");

    d.innerHTML=`<strong>${msg.user}</strong>: ${text} <small>(${msg.time})</small>`;
    messagesDiv.appendChild(d);
    messagesDiv.scrollTop=messagesDiv.scrollHeight;
}

function showChat(chat,partner=null){
    currentChat=chat;
    messagesDiv.innerHTML='';
    showScreen('chatScreen');
    chatTitle.textContent=partner||chat;
    document.getElementById('callBtn').style.display=chat==='–°–ø—ñ–ª—å–Ω–∏–π —á–∞—Ç'?'none':'inline-block';
    
    const chatRef=ref(db,'messages/'+chat);
    onValue(chatRef,snapshot=>{
        messagesDiv.innerHTML='';
        snapshot.forEach(c=>renderMessage(c.val()))
    });
}

function logout(){
    localStorage.removeItem('currentUser');
    currentUser=null;
    showScreen('authScreen');
}

async function sendMessage(){
    const t=messageInput.value.trim();
    if(!t||!currentUser)return;
    push(ref(db,'messages/'+currentChat),{user:currentUser,text:t,time:formatTime(new Date()),type:'text'});
    messageInput.value='';
}

async function sendSticker(url){
    push(ref(db,'messages/'+currentChat),{user:currentUser,url,type:'sticker',time:formatTime(new Date())});
}

async function sendAudio(blob){
    const fileRef=sRef(storage,'audio/'+Date.now()+'.webm');
    await uploadBytes(fileRef,blob);
    const url=await getDownloadURL(fileRef);
    push(ref(db,'messages/'+currentChat),{user:currentUser,url,type:'audio',time:formatTime(new Date())});
}

function applyFormat(format) {
    const start = messageInput.selectionStart;
    const end = messageInput.selectionEnd;
    const text = messageInput.value;
    
    if (start !== end) {
        messageInput.value = text.substring(0, start) + format + text.substring(start, end) + format + text.substring(end);
        messageInput.selectionStart = start + format.length;
        messageInput.selectionEnd = end + format.length;
    } else {
        messageInput.value = text.substring(0, start) + format + format + text.substring(end);
        messageInput.selectionStart = messageInput.selectionEnd = start + format.length;
    }
    messageInput.focus();
}

formatBtn.onclick=()=>formatMenu.style.display=formatMenu.style.display==='flex'?'none':'flex'
formatMenu.querySelectorAll('button').forEach(b=>b.onclick=e=>{
    applyFormat(e.target.dataset.format);
    formatMenu.style.display = 'none';
})
document.querySelectorAll('#emojiPicker img').forEach(i=>i.onclick=e=>sendSticker(e.target.src))

document.getElementById('registerBtn').onclick=register
document.getElementById('loginBtn').onclick=login
document.getElementById('backMenu').onclick=()=>window.location.href='https://ua3012.github.io/ZefaApps/index.html'
document.getElementById('logoutMenu').onclick=logout
document.getElementById('backChat').onclick=()=>showMenu(true)
document.getElementById('backVoice').onclick=()=>showMenu(true)
document.getElementById('backAuth').onclick=()=>window.location.href='https://ua3012.github.io/ZefaApps/index.html'
document.getElementById('publicChatBtn').onclick=()=>showChat('–°–ø—ñ–ª—å–Ω–∏–π —á–∞—Ç')
document.getElementById('sendBtn').onclick=sendMessage

let mediaRecorder
voiceMsgBtn.onclick=async()=>{
    if(!currentUser) return alert('–¢—Ä–µ–±–∞ —É–≤—ñ–π—Ç–∏!')
    if(mediaRecorder&&mediaRecorder.state==='recording'){
        mediaRecorder.stop();
        voiceMsgBtn.classList.remove('active');
        return
    }
    try {
        const stream=await navigator.mediaDevices.getUserMedia({audio:true})
        mediaRecorder=new MediaRecorder(stream)
        voiceMsgBtn.classList.add('active')
        let chunks=[]
        mediaRecorder.ondataavailable=e=>chunks.push(e.data)
        mediaRecorder.onstop=e=>{
            stream.getTracks().forEach(track => track.stop());
            sendAudio(new Blob(chunks,{type:'audio/webm'}));
            voiceMsgBtn.classList.remove('active');
        }
        mediaRecorder.start()
    } catch(e) {
        alert('–ü–æ–º–∏–ª–∫–∞ –¥–æ—Å—Ç—É–ø—É –¥–æ –º—ñ–∫—Ä–æ—Ñ–æ–Ω–∞: ' + e.message)
    }
}

document.getElementById('publicVoiceBtn').onclick=async()=>{
    if(!currentUser) return alert('–¢—Ä–µ–±–∞ —É–≤—ñ–π—Ç–∏!')
    showScreen('voiceScreen');
    voiceUsersDiv.innerHTML='<p>–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –∞—É–¥—ñ–æ...</p>';
    
    try {
        localStream=await navigator.mediaDevices.getUserMedia({audio:true})
        
        micToggleBtn.classList.add('active'); 
        micToggleBtn.onclick=()=>{
            const enabled = !localStream.getAudioTracks()[0].enabled;
            localStream.getAudioTracks()[0].enabled = enabled;
            micToggleBtn.classList.toggle('active', enabled);
        }
        voiceUsersDiv.innerHTML='<p>–¢–∏ –≤ –≥–æ–ª–æ—Å–æ–≤–æ–º—É —á–∞—Ç—ñ. –ù–∞—Ç–∏—Å–Ω–∏ –º—ñ–∫—Ä–æ—Ñ–æ–Ω, —â–æ–± –≤–∏–º–∫–Ω—É—Ç–∏/—É–≤—ñ–º–∫–Ω—É—Ç–∏ –∑–≤—É–∫.</p>'
    } catch(e) {
        alert('–ù–µ–º–æ–∂–ª–∏–≤–æ –ø—ñ–¥–∫–ª—é—á–∏—Ç–∏—Å—è –¥–æ –º—ñ–∫—Ä–æ—Ñ–æ–Ω–∞: ' + e.message)
        showMenu(true);
    }
}

window.onload=()=>{
    if(currentUser)showMenu(true);else showScreen('authScreen');
}
</script>
</body>
</html>
