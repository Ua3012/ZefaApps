<!DOCTYPE html>
<html lang='uk'>
<head>
<meta charset='UTF-8'>
<meta name='viewport' content='width=device-width, initial-scale=1.0'>
<title>–ó—î—Ñ–∞–≥—Ä–∞–º</title>
<style>
@font-face{font-family:'Minecraft';src:url('minecraft-mojangles.otf') format('opentype');}
body{margin:0;font-family:Arial,sans-serif;background:url('zefagrambackground.png') center/cover no-repeat;display:flex;flex-direction:column;height:100vh;}
#auth,#menu,#chat,#voiceChat{display:none;flex-direction:column;align-items:center;width:100%;max-width:600px;margin:auto;background:rgba(255,255,255,0.95);border-radius:12px;padding:15px;box-shadow:0 2px 6px rgba(0,0,0,0.2);}
h2{text-align:center;margin:10px 0;}
input,button{padding:10px;margin:5px;border-radius:6px;border:1px solid #ccc;font-size:16px;}
button{cursor:pointer;background:#0084ff;color:white;border:none;}
button:hover{background:#0066cc;}
.topbar{width:100%;display:flex;justify-content:center;align-items:center;position:relative;margin-bottom:10px;}
.back,.logout,.callBtn{position:absolute;top:0;padding:8px 16px;border-radius:20px;color:white;border:none;cursor:pointer;}
.back{left:10px;background:#555;}
.back:hover{background:#333;}
.logout{right:10px;background:#f44336;}
.logout:hover{background:#c0392b;}
.callBtn{right:50px;background:#4caf50;}
.callBtn:hover{background:#388e3c;}
#messages{flex:1;width:100%;overflow-y:auto;background:white;border-radius:10px;padding:10px;margin-bottom:0;}
.message{display:inline-block;clear:both;margin:6px 0;padding:10px;border-radius:15px;max-width:70%;word-wrap:break-word;font-family:'Minecraft',Arial;}
.message strong{color:#0084ff;}
.from-me{background:#cfe9ff;float:right;}
.from-others{background:#e9ecef;float:left;}
#input-area{display:flex;width:100%;border-top:1px solid #ddd;padding:10px;background:rgba(255,255,255,0.95);}
#messageInput{flex:1;border-radius:20px;padding:10px 15px;border:1px solid #ccc;font-size:16px;}
#sendBtn{width:50px;margin-left:10px;border-radius:50%;font-size:20px;}
#formatBtn{margin-right:5px;}
.emojiPicker{display:flex;gap:5px;margin-top:5px;}
.emojiPicker img{width:30px;height:30px;cursor:pointer;}
.menuBtn{padding:10px 15px;width:90%;margin:5px;text-align:center;border-radius:12px;background:#0084ff;color:white;}
.menuBtn:hover{background:#0066cc;}
@media(max-width:500px){#auth,#menu,#chat,#voiceChat{width:95%;padding:10px;}#input-area{padding:5px;}#messageInput{font-size:14px;padding:8px;}}
</style>
</head>
<body>
<div id='auth'>
<h2>–ó—î—Ñ–∞–≥—Ä–∞–º</h2>
<input type='text' id='username' placeholder='–í–≤–µ–¥—ñ—Ç—å —é–∑—î—Ä–Ω–∞–º—î'>
<input type='password' id='password' placeholder='–ü–∞—Ä–æ–ª—å'>
<button id='registerBtn'>–ó–∞—Ä–µ–≥–∞—Ç—å—Å—è</button>
<button id='loginBtn'>–í–æ–π—Ç–∏</button>
<button class='back' onclick='location.href="index.html"'>‚¨Ö –ù–∞–∑–∞–¥</button>
</div>

<div id='menu'>
<h2>–ú–µ–Ω—é —á–∞—Ç—ñ–≤</h2>
<button class='menuBtn' id='publicChatBtn'>–°–ø—ñ–ª—å–Ω–∏–π —á–∞—Ç</button>
<button class='menuBtn' id='publicVoiceBtn'>–°–ø—ñ–ª—å–Ω–∏–π –≥–æ–ª–æ—Å–æ–≤–∏–π —á–∞—Ç</button>
<button class='menuBtn' id='privateChatsBtn'>–ü—Ä–∏–≤–∞—Ç–Ω—ñ —á–∞—Ç–∏</button>
<button class='menuBtn' id='createPrivateBtn'>–°—Ç–≤–æ—Ä–∏—Ç–∏ –ø—Ä–∏–≤–∞—Ç–Ω–∏–π —á–∞—Ç</button>
<button class='back' onclick='showMenu(false)'>‚¨Ö –ù–∞–∑–∞–¥</button>
<button class='logout' id='menuLogoutBtn'>–í–∏–π—Ç—ñ</button>
</div>

<div id='chat'>
<div class='topbar'>
<button class='back' onclick='showMenu(true)'>‚¨Ö</button>
<h2 id='chatTitle'></h2>
<button class='callBtn' id='callBtn'>üìû</button>
<button class='logout' id='chatLogoutBtn'>–í–∏–π—Ç—ñ</button>
</div>
<div id='messages'></div>
<div id='input-area'>
<button id='formatBtn'>‚Ä¶</button>
<input type='text' id='messageInput' placeholder='–ü–Ü–®–ò!!!'>
<button id='sendBtn'>‚Üí</button>
<button id='voiceMsgBtn'>üéôÔ∏è</button>
</div>
<div class='emojiPicker' id='emojiPicker'>
<img src='zefasticker1.png'>
<img src='zefasticker2.png'>
<img src='zefasticker3.png'>
<img src='zefasticker4.png'>
<img src='zefasticker5.png'>
</div>
</div>

<div id='voiceChat'>
<div class='topbar'>
<button class='back' onclick='showMenu(true)'>‚¨Ö</button>
<h2 id='voiceTitle'></h2>
<button class='logout' id='voiceLogoutBtn'>–í–∏–π—Ç—ñ</button>
</div>
<button id='micToggleBtn'>üéôÔ∏è –£–≤—ñ–º–∫–Ω—É—Ç–∏/–í–∏–º–∫–Ω—É—Ç–∏ –º—ñ–∫—Ä–æ—Ñ–æ–Ω</button>
</div>

<script type='module'>
import { initializeApp } from 'https://www.gstatic.com/firebasejs/12.3.0/firebase-app.js'
import { getDatabase, ref, set, push, get, child, onChildAdded } from 'https://www.gstatic.com/firebasejs/12.3.0/firebase-database.js'

const firebaseConfig = {
apiKey:'AIzaSyBp_RXjmWLfK0wX8sDb1d_VQogZgwzaNFA',
authDomain:'zefagram.firebaseapp.com',
databaseURL:'https://zefagram-default-rtdb.europe-west1.firebasedatabase.app',
projectId:'zefagram',
storageBucket:'zefagram.firebasestorage.app',
messagingSenderId:'664999563847',
appId:'1:664999563847:web:3051100a05bdb41dc59762',
measurementId:'G-CFS89PSQNK'
}

const app = initializeApp(firebaseConfig)
const db = getDatabase(app)
let currentUser = localStorage.getItem('currentUser')
let currentChat='public'
let localStream=null, peerConnections={}

const authDiv=document.getElementById('auth')
const menuDiv=document.getElementById('menu')
const chatDiv=document.getElementById('chat')
const voiceDiv=document.getElementById('voiceChat')
const usernameInput=document.getElementById('username')
const passwordInput=document.getElementById('password')
const messagesDiv=document.getElementById('messages')
const chatTitle=document.getElementById('chatTitle')
const messageInput=document.getElementById('messageInput')
const sendBtn=document.getElementById('sendBtn')
const registerBtn=document.getElementById('registerBtn')
const loginBtn=document.getElementById('loginBtn')
const callBtn=document.getElementById('callBtn')
const micToggleBtn=document.getElementById('micToggleBtn')
const voiceMsgBtn=document.getElementById('voiceMsgBtn')

function formatTime(date){return date.getFullYear()+'-'+(date.getMonth()+1)+'-'+date.getDate()+' '+date.getHours()+':'+String(date.getMinutes()).padStart(2,'0')}

async function register(){const u=usernameInput.value.trim();const p=passwordInput.value.trim();if(!u||!p)return alert('–í–≤–µ–¥–∏ —é–∑—î—Ä–Ω–∞–º—î —ñ –ø–∞—Ä–æ–ª—å');const s=await get(child(ref(db),'users/'+u));if(s.exists())return alert('–¢–∞–∫–∏–π —é–∑–µ—Ä –≤–∂–µ —î');await set(ref(db,'users/'+u),{password:p});alert('–¢–∏ –∑–∞—Ä–µ–≥–∞–≤—Å—è!')}
async function login(){const u=usernameInput.value.trim();const p=passwordInput.value.trim();if(!u||!p)return alert('–í–≤–µ–¥–∏ —é–∑—î—Ä–Ω–∞–º—î —ñ –ø–∞—Ä–æ–ª—å');const s=await get(child(ref(db),'users/'+u));if(!s.exists()||s.val().password!==p)return alert('–ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–∏–π —é–∑—î—Ä –∞–±–æ –ø–∞—Ä–æ–ª—å');currentUser=u;localStorage.setItem('currentUser',u);showMenu(true)}

function showMenu(show){authDiv.style.display='none';menuDiv.style.display=show?'flex':'none';chatDiv.style.display='none';voiceDiv.style.display='none'}
function showChat(chat,peer=false){currentChat=chat;chatTitle.textContent=chat;messagesDiv.innerHTML='';authDiv.style.display='none';menuDiv.style.display='none';chatDiv.style.display='flex';voiceDiv.style.display='none'}
function showVoice(chat){voiceDiv.style.display='flex';voiceTitle.textContent=chat;authDiv.style.display='none';menuDiv.style.display='none';chatDiv.style.display='none'}

function logout(){localStorage.removeItem('currentUser');currentUser=null;authDiv.style.display='flex';menuDiv.style.display='none';chatDiv.style.display='none';voiceDiv.style.display='none'}

async function sendMessage(){const t=messageInput.value.trim();if(!t||!currentUser)return;const time=formatTime(new Date());push(ref(db,'messages/'+currentChat),{user:currentUser,text:t,time});messageInput.value=''}
function addMessage(data){const m=data.val();const d=document.createElement('div');d.className='message '+(m.user===currentUser?'from-me':'from-others');d.innerHTML='<strong>'+m.user+'</strong>: '+m.text+' <small>('+m.time+')</small>';messagesDiv.appendChild(d);messagesDiv.scrollTop=messagesDiv.scrollHeight}
onChildAdded(ref(db,'messages/public'),addMessage)

registerBtn.onclick=register
loginBtn.onclick=login
sendBtn.onclick=sendMessage

<script type='module'>
import { initializeApp } from 'https://www.gstatic.com/firebasejs/12.3.0/firebase-app.js'
import { getDatabase, ref, set, push, get, child, onChildAdded, remove } from 'https://www.gstatic.com/firebasejs/12.3.0/firebase-database.js'

const firebaseConfig = {
apiKey:'AIzaSyBp_RXjmWLfK0wX8sDb1d_VQogZgwzaNFA',
authDomain:'zefagram.firebaseapp.com',
databaseURL:'https://zefagram-default-rtdb.europe-west1.firebasedatabase.app',
projectId:'zefagram',
storageBucket:'zefagram.firebasestorage.app',
messagingSenderId:'664999563847',
appId:'1:664999563847:web:3051100a05bdb41dc59762',
measurementId:'G-CFS89PSQNK'
}

const app = initializeApp(firebaseConfig)
const db = getDatabase(app)

let localStream=null
let peers={}
let isMicOn=false

async function startLocalStream(){localStream=await navigator.mediaDevices.getUserMedia({audio:true,video:false})}

async function joinPublicVoice(){showVoice('–°–ø—ñ–ª—å–Ω–∏–π –≥–æ–ª–æ—Å–æ–≤–∏–π —á–∞—Ç');await startLocalStream();const voiceRef=ref(db,'voice/public');onChildAdded(voiceRef,data=>{const msg=data.val();if(msg.type==='offer'){createAnswer(msg.from,msg.offer)}});}

async function createPrivateCall(target){showVoice('–ü—Ä–∏–≤–∞—Ç–Ω–∏–π –≥–æ–ª–æ—Å–æ–≤–∏–π —á–∞—Ç');await startLocalStream();const callRef=ref(db,'voice/private/'+currentUser+'_'+target);const pc=new RTCPeerConnection()
pc.ontrack=e=>{const aud=document.createElement('audio');aud.srcObject=e.streams[0];aud.autoplay=true;document.body.appendChild(aud)}
localStream.getTracks().forEach(t=>pc.addTrack(t,localStream))
const offer=await pc.createOffer();await pc.setLocalDescription(offer);set(callRef,{from:currentUser,offer:offer.sdp})}

async function createAnswer(from,offerSDP){const pc=new RTCPeerConnection()
pc.ontrack=e=>{const aud=document.createElement('audio');aud.srcObject=e.streams[0];aud.autoplay=true;document.body.appendChild(aud)}
localStream.getTracks().forEach(t=>pc.addTrack(t,localStream))
await pc.setRemoteDescription({type:'offer',sdp:offerSDP})
const answer=await pc.createAnswer();await pc.setLocalDescription(answer)
set(ref(db,'voice/private/'+from+'_'+currentUser+'/answer'),{answer:answer.sdp})}

micToggleBtn.onclick=()=>{if(!localStream)return;isMicOn=!isMicOn;localStream.getAudioTracks()[0].enabled=isMicOn}

voiceMsgBtn.onclick=async()=>{if(!localStream)return;const rec=new MediaRecorder(localStream);let data=[];rec.ondataavailable=e=>data.push(e.data);rec.onstop=async()=>{const blob=new Blob(data,{type:'audio/webm'});const reader=new FileReader();reader.onload=()=>{push(ref(db,'messages/'+currentChat),{user:currentUser,text:'[üéôÔ∏è –≥–æ–ª–æ—Å–æ–≤–µ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è]',audio:reader.result,time:formatTime(new Date())})};reader.readAsDataURL(blob)};rec.start();setTimeout(()=>rec.stop(),5000)}

</script>

</script>
</body>
</html>
