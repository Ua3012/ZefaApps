<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>3D –°–∏–º—É–ª—è—Ç–æ—Ä –ö–æ–∑–ª–∞: –•–æ–¥—å–±–∞ (Walking)</title>
    <style>
        body { margin: 0; overflow: hidden; background-color: #f0f0f0; }
        canvas { display: block; }
        #ui {
            position: absolute;
            top: 10px;
            left: 10px;
            color: white;
            font-family: sans-serif;
            z-index: 10;
            background: rgba(0, 0, 0, 0.7);
            padding: 15px;
            border-radius: 8px;
        }
        #loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: black;
            color: white;
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            font-size: 24px;
            z-index: 999;
        }
    </style>
</head>
<body>

    <div id="loading-screen">
        –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è ZEFAGOAT...
        <p id="progress-status">0%</p>
        <p style="font-size: 14px;">(–ü–æ—Ç—Ä—ñ–±–µ–Ω –ª–æ–∫–∞–ª—å–Ω–∏–π —Å–µ—Ä–≤–µ—Ä –¥–ª—è –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —Ñ–∞–π–ª—É .glb)</p>
    </div>

    <div id="ui" style="display: none;">
        <h2>üêê ZEFAGOAT 3D</h2>
        <p>–ö–µ—Ä—É–≤–∞–Ω–Ω—è –≤—ñ–¥ 3-—ó –æ—Å–æ–±–∏:</p>
        <ul>
            <li>**W, A, S, D:** –†—É—Ö –∫–æ–∑–ª–∞ (–ê–Ω—ñ–º–∞—Ü—ñ—è **Walking**)</li>
            <li>**–ü—Ä–æ–±—ñ–ª (Space):** –°—Ç—Ä–∏–±–æ–∫ (–§—ñ–∑–∏—á–Ω–∏–π –ø—ñ–¥–π–æ–º –Ω–∞ 1–º)</li>
        </ul>
        <p id="animation-status">–ü–æ—Ç–æ—á–Ω–∞ –∞–Ω—ñ–º–∞—Ü—ñ—è: ...</p>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://unpkg.com/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
    <script src="https://unpkg.com/three@0.128.0/examples/js/loaders/GLTFLoader.js"></script>

<script>
    // --- 1. –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è –°—Ü–µ–Ω–∏, –ö–∞–º–µ—Ä–∏ —Ç–∞ –†–µ–Ω–¥–µ—Ä–∞ ---
    const scene = new THREE.Scene();
    const camera = new THREE.PerspectiveCamera(50, window.innerWidth / window.innerHeight, 0.1, 1000);
    const renderer = new THREE.WebGLRenderer({ antialias: true });

    renderer.setSize(window.innerWidth, window.innerHeight);
    document.body.appendChild(renderer.domElement);
    
    // –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è –¥–ª—è –Ω–µ–±–∞ —Ç–∞ —Ç—ñ–Ω–µ–π
    const skyColor = 0x87CEEB; 
    renderer.setClearColor(skyColor);
    scene.background = new THREE.Color(skyColor);
    renderer.shadowMap.enabled = true; 
    renderer.shadowMap.type = THREE.PCFSoftShadowMap;

    // --- 2. –ì–ª–æ–±–∞–ª—å–Ω—ñ –ó–º—ñ–Ω–Ω—ñ ---
    let goatModel;
    let mixer;
    const clock = new THREE.Clock();
    
    // –§—ñ–∑–∏–∫–∞ —Ç–∞ —Ä—É—Ö
    const keys = {};
    let isJumping = false;
    let jumpVelocity = 0;
    const initialY = 0.5;
    const jumpHeight = 1.0;
    const gravity = -3.0; 
    const movementSpeed = 0.05;
    
    // –ê–Ω—ñ–º–∞—Ü—ñ—ó: –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ —Ç–æ—á–Ω—É –Ω–∞–∑–≤—É "Walking"
    const AnimationNames = {
        IDLE: 'Idle',
        WALK: 'Walking' // –¢–û–ß–ù–ï –Ü–ú'–Ø –í–ê–®–û–á –ê–ù–Ü–ú–ê–¶–Ü–á
    };
    let activeAction;
    const actions = {};

    // --- 3. –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è –ö–∞–º–µ—Ä–∏ —Ç–∞ –ö–æ–Ω—Ç—Ä–æ–ª—ñ–≤ ---
    const controls = new THREE.OrbitControls(camera, renderer.domElement);
    controls.enableDamping = true;
    controls.dampingFactor = 0.1;
    controls.enablePan = false;
    controls.minDistance = 2;
    controls.maxDistance = 6;
    controls.target.set(0, 0.8, 0); 
    controls.update();

    // --- 4. –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –†–µ—Å—É—Ä—Å—ñ–≤ (GLB) —Ç–∞ –ê–Ω—ñ–º–∞—Ü—ñ—è ---
    
    function initAnimations(gltf) {
        mixer = new THREE.AnimationMixer(gltf.scene);

        gltf.animations.forEach(clip => {
            const name = clip.name;
            const action = mixer.clipAction(clip);
            
            // –ó–±–µ—Ä—ñ–≥–∞—î–º–æ Walking –ø—ñ–¥ —Ç–æ—á–Ω–æ—é –Ω–∞–∑–≤–æ—é
            if (name === AnimationNames.WALK) {
                actions[AnimationNames.WALK] = action;
            } 
            
            // –ü–µ—Ä—à–∞ –∑–Ω–∞–π–¥–µ–Ω–∞ –∞–Ω—ñ–º–∞—Ü—ñ—è –≤–≤–∞–∂–∞—î—Ç—å—Å—è "Idle"
            if (!actions[AnimationNames.IDLE]) {
                 actions[AnimationNames.IDLE] = action;
            }
        });
        
        // –í—Å—Ç–∞–Ω–æ–≤–ª—é—î–º–æ –ø–æ—á–∞—Ç–∫–æ–≤—É –¥—ñ—é (Idle –∞–±–æ –ø–µ—Ä—à—É –∑–Ω–∞–π–¥–µ–Ω—É)
        setAction(actions[AnimationNames.IDLE] ? AnimationNames.IDLE : (actions[AnimationNames.WALK] ? AnimationNames.WALK : null));

        if (!actions[AnimationNames.WALK]) {
            console.warn(`–ü–æ–ø–µ—Ä–µ–¥–∂–µ–Ω–Ω—è: –ê–Ω—ñ–º–∞—Ü—ñ—è '${AnimationNames.WALK}' –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–∞. –†—É—Ö –±—É–¥–µ –±–µ–∑ –∞–Ω—ñ–º–∞—Ü—ñ—ó.`);
        }
    }
    
    function setAction(name) {
        if (!name || !actions[name] || activeAction === actions[name]) return;
        
        const previousAction = activeAction;
        activeAction = actions[name];

        if (previousAction) {
            previousAction.fadeOut(0.3);
        }

        activeAction
            .reset()
            .setEffectiveTimeScale(1)
            .setEffectiveWeight(1)
            .fadeIn(0.3)
            .play();
            
        animationStatus.textContent = `–ü–æ—Ç–æ—á–Ω–∞ –∞–Ω—ñ–º–∞—Ü—ñ—è: ${name}`;
    }

    const gltfLoader = new THREE.GLTFLoader();

    gltfLoader.load(
        'zefagoat.glb',
        (gltf) => {
            goatModel = gltf.scene;
            goatModel.scale.set(1, 1, 1);
            goatModel.position.y = initialY; 
            
            goatModel.traverse((child) => {
                if (child.isMesh) {
                    child.castShadow = true;
                    child.receiveShadow = false;
                }
            });
            scene.add(goatModel);

            initAnimations(gltf);

            loadingScreen.style.display = 'none';
            ui.style.display = 'block';
            
            animate();
        },
        // on progress
        (xhr) => { progressStatus.textContent = `–ü—Ä–æ–≥—Ä–µ—Å: ${Math.round(xhr.loaded / xhr.total * 100)}%`; },
        // on error
        (error) => {
            console.error('–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –º–æ–¥–µ–ª—ñ –∫–æ–∑–ª–∞:', error);
            progressStatus.textContent = '–ü–û–ú–ò–õ–ö–ê! –ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ –∫–æ–Ω—Å–æ–ª—å —Ç–∞ –Ω–∞—è–≤–Ω—ñ—Å—Ç—å —Ñ–∞–π–ª—É zefagoat.glb.';
        }
    );

    // --- 5. –°—Ç–≤–æ—Ä–µ–Ω–Ω—è –°–≤—ñ—Ç—É —Ç–∞ –û—Å–≤—ñ—Ç–ª–µ–Ω–Ω—è ---
    
    // –ó–µ–º–ª—è 
    const groundGeometry = new THREE.PlaneGeometry(100, 100);
    const groundMaterial = new THREE.MeshStandardMaterial({ 
        color: 0x558B2F,
        metalness: 0.1,
        roughness: 0.8
    });
    const ground = new THREE.Mesh(groundGeometry, groundMaterial);
    ground.rotation.x = -Math.PI / 2;
    ground.position.y = 0;
    ground.receiveShadow = true;
    scene.add(ground);

    // –û—Å–≤—ñ—Ç–ª–µ–Ω–Ω—è
    const ambientLight = new THREE.AmbientLight(0xffffff, 0.5); 
    scene.add(ambientLight);

    const sunLight = new THREE.DirectionalLight(0xffffff, 1.5); 
    sunLight.position.set(10, 20, 10);
    sunLight.castShadow = true;
    sunLight.shadow.mapSize.width = 2048;
    sunLight.shadow.mapSize.height = 2048;
    sunLight.shadow.camera.near = 0.5;
    sunLight.shadow.camera.far = 50;
    sunLight.shadow.camera.left = -15;
    sunLight.shadow.camera.right = 15;
    sunLight.shadow.camera.top = 15;
    sunLight.shadow.camera.bottom = -15;
    scene.add(sunLight);
    
    const hemiLight = new THREE.HemisphereLight(0x87CEEB, 0x006400, 0.9);
    scene.add(hemiLight);

    // --- 6. –ö–µ—Ä—É–≤–∞–Ω–Ω—è —Ç–∞ –§—ñ–∑–∏–∫–∞ ---
    
    document.addEventListener('keydown', (event) => {
        keys[event.code] = true;
        if (event.code === 'Space') {
            jumpGoat();
        }
    });
    document.addEventListener('keyup', (event) => {
        keys[event.code] = false;
    });

    /**
     * –°—Ç—Ä–∏–±–æ–∫ –±–µ–∑ –∞–Ω—ñ–º–∞—Ü—ñ—ó, –ø—ñ–¥–Ω—è—Ç—Ç—è –Ω–∞ 1 –º–µ—Ç—Ä.
     */
    function jumpGoat() {
        if (!isJumping) {
            isJumping = true;
            jumpVelocity = Math.sqrt(-2 * gravity * jumpHeight); 
            
            // –ó—É–ø–∏–Ω—è—î–º–æ –∞–Ω—ñ–º–∞—Ü—ñ—é —Ö–æ–¥—å–±–∏/—Å—Ç–æ—è–Ω–Ω—è
            if (activeAction) {
                 activeAction.stop();
                 activeAction = null;
            }
            animationStatus.textContent = `–ü–æ—Ç–æ—á–Ω–∞ –∞–Ω—ñ–º–∞—Ü—ñ—è: –°–¢–†–ò–ë–û–ö (–§—ñ–∑–∏–∫–∞)`;
        }
    }
    
    function handleMovement() {
        let isMoving = false;
        const forward = new THREE.Vector3(0, 0, 1);
        const rotationMatrix = new THREE.Matrix4();
        rotationMatrix.extractRotation(camera.matrix);
        forward.applyMatrix4(rotationMatrix);
        forward.y = 0;
        forward.normalize();
        
        const right = new THREE.Vector3();
        right.crossVectors(forward, new THREE.Vector3(0, 1, 0)); 
        
        let deltaPosition = new THREE.Vector3();

        if (keys['KeyW']) {
            deltaPosition.add(forward.multiplyScalar(-movementSpeed));
            isMoving = true;
        }
        if (keys['KeyS']) {
            deltaPosition.add(forward.multiplyScalar(movementSpeed));
            isMoving = true;
        }
        if (keys['KeyA']) {
            deltaPosition.add(right.multiplyScalar(-movementSpeed));
            isMoving = true;
        }
        if (keys['KeyD']) {
            deltaPosition.add(right.multiplyScalar(movementSpeed));
            isMoving = true;
        }
        
        if (isMoving) {
            const angle = Math.atan2(-deltaPosition.x, -deltaPosition.z);
            goatModel.rotation.y = angle;

            goatModel.position.add(deltaPosition);

            // –ê–Ω—ñ–º–∞—Ü—ñ—è —Ö–æ–¥—å–±–∏, —Ç—ñ–ª—å–∫–∏ —è–∫—â–æ –Ω–µ —Å—Ç—Ä–∏–±–∞—î–º–æ
            if (!isJumping) {
                // –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ –ª–∏—à–µ 'Walking' –¥–ª—è —Ä—É—Ö—É
                setAction(AnimationNames.WALK);
            }
        } else if (!isJumping) {
            // –ê–Ω—ñ–º–∞—Ü—ñ—è IDLE, —è–∫—â–æ –Ω–µ —Ä—É—Ö–∞—î–º–æ—Å—è —ñ –Ω–µ —Å—Ç—Ä–∏–±–∞—î–º–æ
            setAction(AnimationNames.IDLE);
        }
    }

    function applyGravity() {
        if (isJumping) {
            const delta = clock.getDelta();
            jumpVelocity += gravity * delta;
            goatModel.position.y += jumpVelocity * delta;

            if (goatModel.position.y <= initialY) {
                goatModel.position.y = initialY;
                isJumping = false;
                jumpVelocity = 0;
                
                // –ü–æ–≤–µ—Ä—Ç–∞—î–º–æ—Å—å –¥–æ IDLE/WALK –∑–∞–ª–µ–∂–Ω–æ –≤—ñ–¥ –Ω–∞—Ç–∏—Å–∫–∞–Ω–Ω—è –∫–ª–∞–≤—ñ—à
                const currentlyMoving = keys['KeyW'] || keys['KeyS'] || keys['KeyA'] || keys['KeyD'];
                setAction(currentlyMoving ? AnimationNames.WALK : AnimationNames.IDLE);
            }
        }
    }
    
    function updateCameraTarget() {
        controls.target.copy(goatModel.position);
        controls.target.y += 0.8;
        controls.update();
    }

    // --- 7. –ê–Ω—ñ–º–∞—Ü—ñ–π–Ω–∏–π –¶–∏–∫–ª (–†–µ–Ω–¥–µ—Ä–∏–Ω–≥) ---

    function animate() {
        requestAnimationFrame(animate);

        const delta = clock.getDelta();

        if (goatModel && mixer) {
            // –û–Ω–æ–≤–ª—é—î–º–æ –º—ñ–∫—à–µ—Ä –∞–Ω—ñ–º–∞—Ü—ñ–π, —Ç—ñ–ª—å–∫–∏ —è–∫—â–æ —î –∞–∫—Ç–∏–≤–Ω–∞ –¥—ñ—è (WALK/IDLE)
            if (activeAction) {
                mixer.update(delta);
            }
            
            handleMovement();
            applyGravity();
            updateCameraTarget();
            
            // –û–Ω–æ–≤–ª—é—î–º–æ –ø–æ–∑–∏—Ü—ñ—é —Å–≤—ñ—Ç–ª–∞
            sunLight.position.set(
                goatModel.position.x + 10,
                goatModel.position.y + 20, 
                goatModel.position.z + 10
            );
            sunLight.target.copy(goatModel.position);
        }

        renderer.render(scene, camera);
    }

    // --- 8. –ê–¥–∞–ø—Ç–∏–≤–Ω—ñ—Å—Ç—å (Resize) ---
    window.addEventListener('resize', () => {
        camera.aspect = window.innerWidth / window.innerHeight;
        camera.updateProjectionMatrix();
        renderer.setSize(window.innerWidth, window.innerHeight);
    });

</script>

</body>
</html>
