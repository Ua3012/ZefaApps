<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>3D –°–∏–º—É–ª—è—Ç–æ—Ä –ö–æ–∑–ª–∞: –ö–µ—Ä—É–≤–∞–Ω–Ω—è –≤—ñ–¥ 3-—ó –æ—Å–æ–±–∏</title>
    <style>
        body { margin: 0; overflow: hidden; background-color: #f0f0f0; }
        canvas { display: block; }
        #ui {
            position: absolute;
            top: 10px;
            left: 10px;
            color: white;
            font-family: sans-serif;
            z-index: 10;
            background: rgba(0, 0, 0, 0.7);
            padding: 15px;
            border-radius: 8px;
        }
        #loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: black;
            color: white;
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            font-size: 24px;
            z-index: 999;
        }
    </style>
</head>
<body>

    <div id="loading-screen">
        –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è World/Goat...
        <p id="progress-status">0%</p>
        <p style="font-size: 14px;">(–ü–æ—Ç—Ä—ñ–±–µ–Ω –ª–æ–∫–∞–ª—å–Ω–∏–π —Å–µ—Ä–≤–µ—Ä –¥–ª—è –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —Ñ–∞–π–ª—ñ–≤ .glb —Ç–∞ .png)</p>
    </div>

    <div id="ui" style="display: none;">
        <h2>üêê ZEFAGOAT 3D</h2>
        <p>–ö–µ—Ä—É–≤–∞–Ω–Ω—è –≤—ñ–¥ 3-—ó –æ—Å–æ–±–∏:</p>
        <ul>
            <li>**W, A, S, D:** –†—É—Ö –∫–æ–∑–ª–∞</li>
            <li>**–ü—Ä–æ–±—ñ–ª (Space):** –°—Ç—Ä–∏–±–æ–∫</li>
            <li>**–ú–∏—à–∞ (–ù–∞—Ç–∏—Å–Ω—É—Ç–∏ —Ç–∞ —Ç—è–≥–Ω—É—Ç–∏):** –û–±–µ—Ä—Ç–∞—Ç–∏ –∫–∞–º–µ—Ä—É</li>
        </ul>
        <p id="animation-status">–ü–æ—Ç–æ—á–Ω–∞ –∞–Ω—ñ–º–∞—Ü—ñ—è: ...</p>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://unpkg.com/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
    <script src="https://unpkg.com/three@0.128.0/examples/js/loaders/GLTFLoader.js"></script>

<script>
    // --- 1. –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è –°—Ü–µ–Ω–∏, –ö–∞–º–µ—Ä–∏ —Ç–∞ –†–µ–Ω–¥–µ—Ä–∞ ---
    const scene = new THREE.Scene();
    const camera = new THREE.PerspectiveCamera(50, window.innerWidth / window.innerHeight, 0.1, 1000);
    const renderer = new THREE.WebGLRenderer({ antialias: true });

    renderer.setSize(window.innerWidth, window.innerHeight);
    document.body.appendChild(renderer.domElement);
    renderer.shadowMap.enabled = true; // –£–≤—ñ–º–∫–Ω–µ–Ω–Ω—è —Ç—ñ–Ω–µ–π
    renderer.setClearColor(0x000000); // –ß–æ—Ä–Ω–∏–π —Ñ–æ–Ω –ø–µ—Ä–µ–¥ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è–º

    // --- 2. –ì–ª–æ–±–∞–ª—å–Ω—ñ –ó–º—ñ–Ω–Ω—ñ ---
    let goatModel;
    let mixer; // –î–ª—è –∞–Ω—ñ–º–∞—Ü—ñ–π
    const clock = new THREE.Clock(); // –î–ª—è –∫–µ—Ä—É–≤–∞–Ω–Ω—è —á–∞—Å–æ–º –∞–Ω—ñ–º–∞—Ü—ñ–π
    
    // –ö–µ—Ä—É–≤–∞–Ω–Ω—è
    const keys = {};
    let isJumping = false;
    let jumpVelocity = 0;
    const gravity = -1.5;
    const movementSpeed = 0.05;
    
    // –ï–ª–µ–º–µ–Ω—Ç–∏ UI
    const loadingScreen = document.getElementById('loading-screen');
    const progressStatus = document.getElementById('progress-status');
    const ui = document.getElementById('ui');
    const animationStatus = document.getElementById('animation-status');
    
    // –ù–∞–∑–≤–∏ –∞–Ω—ñ–º–∞—Ü—ñ–π (–ø—Ä–∏–ø—É—Å–∫–∞—î–º–æ —Ç–∏–ø–æ–≤—ñ –Ω–∞–∑–≤–∏ –∑ GLB —Ñ–∞–π–ª—É)
    const AnimationNames = {
        IDLE: 'Idle',
        WALK: 'Walk',
        RUN: 'Run',
        JUMP: 'Jump',
        RAM: 'Ram' // –ë—É—Ü–Ω—É—Ç–∏
    };
    let activeAction;
    const actions = {};

    // --- 3. –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è –ö–∞–º–µ—Ä–∏ —Ç–∞ –ö–æ–Ω—Ç—Ä–æ–ª—ñ–≤ (Third-Person) ---
    // –ö–∞–º–µ—Ä–∞ –Ω–µ –æ–±–µ—Ä—Ç–∞—î —Å—Ü–µ–Ω—É, –∞ –ª–∏—à–µ –ø–µ—Ä–µ–º—ñ—â—É—î—Ç—å—Å—è
    const controls = new THREE.OrbitControls(camera, renderer.domElement);
    controls.enableDamping = true; // –ü–ª–∞–≤–Ω—ñ—à–µ –∫–µ—Ä—É–≤–∞–Ω–Ω—è
    controls.dampingFactor = 0.1;
    controls.enablePan = false; // –í–∏–º–∏–∫–∞—î–º–æ –∑–º—ñ—â–µ–Ω–Ω—è –∫–∞–º–µ—Ä–∏
    controls.minDistance = 2;
    controls.maxDistance = 6;
    controls.target.set(0, 0.8, 0); // –ü–æ—á–∞—Ç–∫–æ–≤–∏–π —Ñ–æ–∫—É—Å –Ω–∞ —Ä—ñ–≤–Ω—ñ –∫–æ–∑–ª–∞
    controls.update();

    // --- 4. –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –†–µ—Å—É—Ä—Å—ñ–≤ ---
    
    // –°—Ç–≤–æ—Ä–µ–Ω–Ω—è Skybox –∑ —Ç–µ–∫—Å—Ç—É—Ä–∏ goatzefalatorworldbox.png
    function createSkyBox() {
        const sides = [
            'goatzefalatorworldbox.png', 'goatzefalatorworldbox.png', // X+ X-
            'goatzefalatorworldbox.png', 'goatzefalatorworldbox.png', // Y+ Y-
            'goatzefalatorworldbox.png', 'goatzefalatorworldbox.png'  // Z+ Z-
        ];
        
        const loader = new THREE.CubeTextureLoader();
        const texture = loader.load(sides, () => {
            scene.background = texture;
            console.log('Skybox (Worldbox) –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–æ.');
        });
    }
    
    function initAnimations(gltf) {
        mixer = new THREE.AnimationMixer(gltf.scene);
        
        gltf.animations.forEach(clip => {
            const action = mixer.clipAction(clip);
            actions[clip.name] = action;
        });

        // –ü–æ—á–∞—Ç–∫–æ–≤–∞ –∞–Ω—ñ–º–∞—Ü—ñ—è - "–°—Ç–æ—è—Ç–∏"
        setAction(AnimationNames.IDLE);
    }
    
    function setAction(name) {
        if (!actions[name] || activeAction === actions[name]) return;
        
        const previousAction = activeAction;
        activeAction = actions[name];

        if (previousAction) {
            previousAction.fadeOut(0.3);
        }

        activeAction
            .reset()
            .setEffectiveTimeScale(1)
            .setEffectiveWeight(1)
            .fadeIn(0.3)
            .play();
            
        animationStatus.textContent = `–ü–æ—Ç–æ—á–Ω–∞ –∞–Ω—ñ–º–∞—Ü—ñ—è: ${name}`;
    }

    const gltfLoader = new THREE.GLTFLoader();

    gltfLoader.load(
        'zefagoat.glb',
        (gltf) => {
            goatModel = gltf.scene;
            goatModel.scale.set(1, 1, 1);
            goatModel.position.y = 0.5; 
            goatModel.traverse((child) => {
                if (child.isMesh) {
                    child.castShadow = true;
                    child.receiveShadow = true;
                }
            });
            scene.add(goatModel);

            initAnimations(gltf); // –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑—É—î–º–æ –∞–Ω—ñ–º–∞—Ü—ñ—ó
            createSkyBox(); // –°—Ç–≤–æ—Ä—é—î–º–æ –Ω–µ–±–æ –ø—ñ—Å–ª—è –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –º–æ–¥–µ–ª—ñ

            // –ü—ñ—Å–ª—è —É—Å–ø—ñ—à–Ω–æ–≥–æ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è
            loadingScreen.style.display = 'none';
            ui.style.display = 'block';
            
            animate(); // –ó–∞–ø—É—Å–∫–∞—î–º–æ —Ü–∏–∫–ª –ø—ñ—Å–ª—è –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è
        },
        // on progress
        (xhr) => { progressStatus.textContent = `–ü—Ä–æ–≥—Ä–µ—Å: ${Math.round(xhr.loaded / xhr.total * 100)}%`; },
        // on error
        (error) => {
            console.error('–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —Ä–µ—Å—É—Ä—Å—ñ–≤:', error);
            progressStatus.textContent = '–ü–û–ú–ò–õ–ö–ê! –ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ –∫–æ–Ω—Å–æ–ª—å —Ç–∞ –Ω–∞—è–≤–Ω—ñ—Å—Ç—å —Ñ–∞–π–ª—ñ–≤ –Ω–∞ —Å–µ—Ä–≤–µ—Ä—ñ.';
        }
    );

    // --- 5. –°—Ç–≤–æ—Ä–µ–Ω–Ω—è –°–≤—ñ—Ç—É (–ó–µ–º–ª—è —Ç–∞ –û—Å–≤—ñ—Ç–ª–µ–Ω–Ω—è) ---

    // –ó–µ–º–ª—è 
    const groundGeometry = new THREE.PlaneGeometry(100, 100);
    const groundMaterial = new THREE.MeshLambertMaterial({ color: 0x8FBC8F }); // –¢—Ä–∞–≤–∞
    const ground = new THREE.Mesh(groundGeometry, groundMaterial);
    ground.rotation.x = -Math.PI / 2;
    ground.receiveShadow = true;
    scene.add(ground);

    // –û—Å–≤—ñ—Ç–ª–µ–Ω–Ω—è
    const ambientLight = new THREE.AmbientLight(0xffffff, 0.7);
    scene.add(ambientLight);

    const directionalLight = new THREE.DirectionalLight(0xffffff, 1.2);
    directionalLight.position.set(5, 15, 5);
    directionalLight.castShadow = true;
    directionalLight.shadow.mapSize.width = 2048;
    directionalLight.shadow.mapSize.height = 2048;
    directionalLight.shadow.camera.near = 0.5;
    directionalLight.shadow.camera.far = 50;
    scene.add(directionalLight);

    // --- 6. –ö–µ—Ä—É–≤–∞–Ω–Ω—è —Ç–∞ –§—ñ–∑–∏–∫–∞ ---

    // –û–±—Ä–æ–±–∫–∞ –Ω–∞—Ç–∏—Å–∫–∞–Ω–Ω—è –∫–ª–∞–≤—ñ—à
    document.addEventListener('keydown', (event) => {
        keys[event.code] = true;
        if (event.code === 'Space') {
            jumpGoat();
        }
    });
    document.addEventListener('keyup', (event) => {
        keys[event.code] = false;
    });

    function jumpGoat() {
        if (!isJumping) {
            isJumping = true;
            jumpVelocity = 0.5; // –°–∏–ª–∞ —Å—Ç—Ä–∏–±–∫–∞
            setAction(AnimationNames.JUMP); // –í—Å—Ç–∞–Ω–æ–≤–ª—é—î–º–æ –∞–Ω—ñ–º–∞—Ü—ñ—é —Å—Ç—Ä–∏–±–∫–∞
        }
    }
    
    function handleMovement() {
        let isMoving = false;
        const forward = new THREE.Vector3(0, 0, 1);
        const rotationMatrix = new THREE.Matrix4();
        
        // –û—Ç—Ä–∏–º—É—î–º–æ –Ω–∞–ø—Ä—è–º–æ–∫, –∫—É–¥–∏ –¥–∏–≤–∏—Ç—å—Å—è –∫–∞–º–µ—Ä–∞ (–¥–ª—è —ñ–Ω—Ç—É—ó—Ç–∏–≤–Ω–æ–≥–æ –∫–µ—Ä—É–≤–∞–Ω–Ω—è)
        rotationMatrix.extractRotation(camera.matrix);
        forward.applyMatrix4(rotationMatrix);
        forward.y = 0; // –ó–∞–ª–∏—à–∞—î–º–æ —Ä—É—Ö –ª–∏—à–µ –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–∏–º
        forward.normalize();
        
        const right = new THREE.Vector3();
        right.crossVectors(forward, new THREE.Vector3(0, 1, 0)); // –í–µ–∫—Ç–æ—Ä –≤–ø—Ä–∞–≤–æ
        
        let deltaPosition = new THREE.Vector3();

        // W - –í–ø–µ—Ä–µ–¥
        if (keys['KeyW']) {
            deltaPosition.add(forward.multiplyScalar(-movementSpeed)); // –ú—ñ–Ω—É—Å, –±–æ GLTF-–º–æ–¥–µ–ª—ñ —á–∞—Å—Ç–æ –¥–∏–≤–ª—è—Ç—å—Å—è –≤–∑–¥–æ–≤–∂ Z+
            isMoving = true;
        }
        // S - –ù–∞–∑–∞–¥
        if (keys['KeyS']) {
            deltaPosition.add(forward.multiplyScalar(movementSpeed));
            isMoving = true;
        }
        // A - –í–ª—ñ–≤–æ
        if (keys['KeyA']) {
            deltaPosition.add(right.multiplyScalar(-movementSpeed));
            isMoving = true;
        }
        // D - –í–ø—Ä–∞–≤–æ
        if (keys['KeyD']) {
            deltaPosition.add(right.multiplyScalar(movementSpeed));
            isMoving = true;
        }
        
        if (isMoving) {
            // –û–±–µ—Ä—Ç–∞–Ω–Ω—è –º–æ–¥–µ–ª—ñ –≤ –Ω–∞–ø—Ä—è–º–∫—É —Ä—É—Ö—É
            const angle = Math.atan2(-deltaPosition.x, -deltaPosition.z);
            goatModel.rotation.y = angle;

            // –†—É—Ö –º–æ–¥–µ–ª—ñ
            goatModel.position.add(deltaPosition);

            // –ê–Ω—ñ–º–∞—Ü—ñ—è: –±—ñ–≥ (—è–∫—â–æ –Ω–µ —Å—Ç—Ä–∏–±–∞—î–º–æ)
            if (!isJumping) {
                setAction(AnimationNames.WALK);
            }
        } else if (!isJumping) {
            // –ê–Ω—ñ–º–∞—Ü—ñ—è: —Å—Ç–æ—è—Ç–∏, —è–∫—â–æ –Ω–µ —Ä—É—Ö–∞—î–º–æ—Å—è
            setAction(AnimationNames.IDLE);
        }
    }

    function applyGravity() {
        if (isJumping) {
            jumpVelocity += gravity * clock.getDelta();
            goatModel.position.y += jumpVelocity;

            // –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –ø—Ä–∏–∑–µ–º–ª–µ–Ω–Ω—è
            if (goatModel.position.y <= 0.5) {
                goatModel.position.y = 0.5;
                isJumping = false;
                jumpVelocity = 0;
                setAction(AnimationNames.IDLE); // –ü–æ–≤–µ—Ä—Ç–∞—î–º–æ—Å—å –¥–æ —Å—Ç–æ—è–Ω–Ω–Ω—è
            }
        }
    }
    
    function updateCameraTarget() {
        // –ö–∞–º–µ—Ä–∞ –∑–∞–≤–∂–¥–∏ —Å–ª—ñ–¥—É—î –∑–∞ –∫–æ–∑–ª–æ–º
        controls.target.copy(goatModel.position);
        controls.target.y += 0.8; // –¢—Ä–∏–º–∞—î–º–æ —Ñ–æ–∫—É—Å —Ç—Ä–æ—Ö–∏ –≤–∏—â–µ –∑–µ–º–ª—ñ
        controls.update();
    }

    // --- 7. –ê–Ω—ñ–º–∞—Ü—ñ–π–Ω–∏–π –¶–∏–∫–ª (–†–µ–Ω–¥–µ—Ä–∏–Ω–≥) ---

    function animate() {
        requestAnimationFrame(animate);

        const delta = clock.getDelta();

        if (goatModel && mixer) {
            // –û–Ω–æ–≤–ª—é—î–º–æ –º—ñ–∫—à–µ—Ä –∞–Ω—ñ–º–∞—Ü—ñ–π
            mixer.update(delta);
            
            // –û–±—Ä–æ–±–ª—è—î–º–æ —Ä—É—Ö
            handleMovement();
            
            // –û–±—Ä–æ–±–ª—è—î–º–æ –≥—Ä–∞–≤—ñ—Ç–∞—Ü—ñ—é —Ç–∞ —Å—Ç—Ä–∏–±–∫–∏
            applyGravity();
            
            // –û–Ω–æ–≤–ª—é—î–º–æ –ø–æ–∑–∏—Ü—ñ—é —Ñ–æ–∫—É—Å–∞ –∫–∞–º–µ—Ä–∏
            updateCameraTarget();
        }

        renderer.render(scene, camera);
    }

    // –ü—Ä–∏–º—ñ—Ç–∫–∞: –§—É–Ω–∫—Ü—ñ—è animate() –≤–∏–∫–ª–∏–∫–∞—î—Ç—å—Å—è –ø—ñ—Å–ª—è —É—Å–ø—ñ—à–Ω–æ–≥–æ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –º–æ–¥–µ–ª—ñ
    
    // --- 8. –ê–¥–∞–ø—Ç–∏–≤–Ω—ñ—Å—Ç—å (Resize) ---
    window.addEventListener('resize', () => {
        camera.aspect = window.innerWidth / window.innerHeight;
        camera.updateProjectionMatrix();
        renderer.setSize(window.innerWidth, window.innerHeight);
    });

</script>

</body>
</html>
