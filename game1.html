<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>3D Лабіринт — Three.js (FPS, авто Pointer Lock)</title>
  <style>
    html,body{height:100%;margin:0;background:#111;font-family:sans-serif;user-select:none;}
    #container{position:relative;width:100vw;height:100vh;overflow:hidden}
    canvas{display:block;width:100%;height:100%}
    #ui{position:absolute;z-index:2;right:12px;top:12px;color:#fff;background:rgba(0,0,0,0.35);padding:8px 10px;border-radius:8px;}
    #minimap{position:absolute;left:12px;top:12px;width:180px;height:180px;background:rgba(0,0,0,0.22);border-radius:8px;z-index:2;padding:6px;}
    #minimap canvas{display:block;width:100%;height:100%;}
    #reset{position:absolute;right:12px;bottom:18px;z-index:2}
    button{background:transparent;color:#fff;border:1px solid #fff3;padding:8px 10px;border-radius:8px;cursor:pointer}
    #pointerlock-instruct { position:absolute; left:0; right:0; top:0; bottom:0;display:flex;align-items:center;justify-content:center;z-index:10;}
    #pointerlock-instruct span{background:rgba(0,0,0,.7);color:#fff;padding:18px 24px;border-radius:10px;font-size:1.2em;}
  </style>
</head>
<body>
<div id="container">
  <div id="minimap"><canvas id="mm" width="180" height="180"></canvas></div>
  <div id="ui">WASD / стрілки — рух<br>Миша — огляд</div>
  <button id="reset">Відновити позицію</button>
  <div id="pointerlock-instruct"><span>Почни рух миші або натисни клавішу для керування</span></div>
</div>
<script type="module">
async function loadThree() {
  try { return await import('./three.module.min.js'); }
  catch { return await import('https://unpkg.com/three@0.162.0/build/three.module.min.js'); }
}
const THREE = await loadThree();

const map = [
  [1,1,1,1,1,1,1,1,1,1,1,1],
  [1,0,0,0,0,0,0,0,0,0,0,1],
  [1,0,1,0,1,1,1,0,1,1,0,1],
  [1,0,1,0,0,0,1,0,0,1,0,1],
  [1,0,1,1,1,0,1,1,0,1,0,1],
  [1,0,0,0,1,0,0,0,0,1,0,1],
  [1,1,1,0,1,1,1,1,0,1,0,1],
  [1,0,0,0,0,0,0,1,0,0,0,1],
  [1,0,1,1,1,1,0,1,1,1,0,1],
  [1,0,0,0,0,0,0,0,0,0,0,1],
  [1,1,1,1,1,1,1,1,1,1,1,1]
];
const TILE = 64, HALF = TILE/2;

const container = document.getElementById('container');
const renderer = new THREE.WebGLRenderer({antialias:true});
renderer.setSize(window.innerWidth, window.innerHeight);
container.insertBefore(renderer.domElement, container.firstChild);

const scene = new THREE.Scene();
scene.background = new THREE.Color(0x7fbfff);
const camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 5000);

scene.add(new THREE.DirectionalLight(0xffffff, 0.9).position.set(1,2,1).normalize());
scene.add(new THREE.AmbientLight(0x606060));
const wallMat = new THREE.MeshStandardMaterial({color:0x888888});
const wallGeo = new THREE.BoxGeometry(TILE, TILE, TILE);
for(let z=0; z<map.length; z++)
  for(let x=0; x<map[0].length; x++)
    if(map[z][x])
      scene.add(new THREE.Mesh(wallGeo, wallMat).position.set(x*TILE+HALF,HALF,z*TILE+HALF));
const floor = new THREE.Mesh(
  new THREE.PlaneGeometry(map[0].length*TILE, map.length*TILE),
  new THREE.MeshStandardMaterial({color:0x444})
);
floor.rotation.x = -Math.PI/2;
floor.position.set(map[0].length*TILE/2, 0, map.length*TILE/2);
scene.add(floor);

const startPos = { x:1.5, z:1.5, yaw:0, pitch:0 };
const player = {
  x: startPos.x * TILE, z: startPos.z * TILE, y: 32,
  yaw: startPos.yaw, pitch: startPos.pitch,
  speed: 150, turnSpeed: 0.0025, pitchSpeed: 0.002
};
function syncCamera(){
  camera.position.set(player.x, player.y, player.z);
  camera.rotation.x = player.pitch;
  camera.rotation.y = player.yaw;
}
syncCamera();

function isWallAt(px, pz){
  const mx = Math.floor(px/TILE), mz = Math.floor(pz/TILE);
  if(mz<0||mz>=map.length||mx<0||mx>=map[0].length) return true;
  return map[mz][mx] === 1;
}

let pointerLocked = false;
const instruct = document.getElementById('pointerlock-instruct');
function showInstruct(visible) { instruct.style.display = visible?'flex':'none'; }
showInstruct(true);

// --- Активуємо PointerLock при першій дії користувача ---
function autoPointerLock(e) {
  if (!pointerLocked) {
    renderer.domElement.requestPointerLock();
  }
}
window.addEventListener('mousemove', autoPointerLock, {once:true});
window.addEventListener('keydown', autoPointerLock, {once:true});
instruct.addEventListener('click', autoPointerLock);

document.addEventListener('pointerlockchange', ()=>{
  pointerLocked = document.pointerLockElement === renderer.domElement;
  showInstruct(!pointerLocked);
});
renderer.domElement.addEventListener('mousemove',e=>{
  if(pointerLocked){
    player.yaw -= e.movementX * player.turnSpeed;
    player.pitch -= e.movementY * player.pitchSpeed;
    player.pitch = Math.max(-Math.PI/2, Math.min(Math.PI/2, player.pitch));
  }
});

const keys = {};
window.addEventListener('keydown', e=>keys[e.key.toLowerCase()]=true);
window.addEventListener('keyup', e=>keys[e.key.toLowerCase()]=false);

let prev=performance.now();
function loop(now){
  const dt = (now-prev)/1000; prev=now;
  let forward=0,strafe=0;
  if(keys['w']||keys['arrowup'])forward+=1;
  if(keys['s']||keys['arrowdown'])forward-=1;
  if(keys['a']||keys['arrowleft'])strafe-=1;
  if(keys['d']||keys['arrowright'])strafe+=1;
  const mag = Math.hypot(forward,strafe)||1;
  forward/=mag; strafe/=mag;

  const sin = Math.sin(player.yaw), cos = Math.cos(player.yaw);
  const vx = (cos * forward + sin * strafe) * player.speed * dt;
  const vz = (sin * forward - cos * strafe) * player.speed * dt;
  const pad=18, nx=player.x+vx, nz=player.z+vz;
  if(!isWallAt(nx+pad*Math.sign(vx||1), player.z)) player.x=nx;
  if(!isWallAt(player.x, nz+pad*Math.sign(vz||1))) player.z=nz;

  syncCamera();
  renderer.render(scene, camera);
  renderMinimap();
  requestAnimationFrame(loop);
}
requestAnimationFrame(loop);

const mm = document.getElementById('mm'), mmCtx = mm.getContext('2d');
function renderMinimap(){
  const W=mm.width,H=mm.height,scale=Math.min((W-8)/(map[0].length*TILE),(H-8)/(map.length*TILE)),ox=4,oy=4;
  mmCtx.clearRect(0,0,W,H);
  mmCtx.fillStyle='rgba(0,0,0,0.15)'; mmCtx.fillRect(0,0,W,H);
  for(let z=0;z<map.length;z++)
    for(let x=0;x<map[0].length;x++){
      mmCtx.fillStyle=map[z][x]?'#222':'#ddd';
      mmCtx.fillRect(ox+x*TILE*scale, oy+z*TILE*scale, TILE*scale-1, TILE*scale-1);
    }
  const px=ox+player.x*scale, pz=oy+player.z*scale;
  mmCtx.fillStyle='lime'; mmCtx.beginPath(); mmCtx.arc(px,pz,6,0,Math.PI*2); mmCtx.fill();
  mmCtx.strokeStyle='green';
  mmCtx.beginPath();
  mmCtx.moveTo(px,pz);
  mmCtx.lineTo(px+Math.cos(player.yaw)*24, pz+Math.sin(player.yaw)*24);
  mmCtx.stroke();
}

document.getElementById('reset').onclick=()=>{
  player.x = startPos.x*TILE; player.z = startPos.z*TILE;
  player.yaw = startPos.yaw; player.pitch = startPos.pitch; syncCamera();
};

window.addEventListener('resize',()=>{
  renderer.setSize(window.innerWidth, window.innerHeight);
  camera.aspect = window.innerWidth/window.innerHeight;
  camera.updateProjectionMatrix();
});
</script>
</body>
</html>
