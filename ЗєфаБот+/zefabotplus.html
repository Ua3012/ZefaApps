<!DOCTYPE html>
<html lang='uk'>
<head>
<meta charset='UTF-8'>
<meta name='viewport' content='width=device-width, initial-scale=1.0'>
<title>–ó—î—Ñ–∞–ë–æ—Ç+</title>
<style>
@font-face{font-family:'Minecraft';src:url('minecraft-mojangles.otf') format('opentype');}
body{margin:0;font-family:Arial,sans-serif;background:url('zefagrambackground.png') center/cover no-repeat;display:flex;flex-direction:column;height:100vh;}
.screen{display:none;flex-direction:column;align-items:center;width:100%;max-width:600px;margin:auto;background:rgba(255,255,255,0.95);border-radius:12px;padding:15px;box-shadow:0 2px 6px rgba(0,0,0,0.2);height:95vh;}
h2{text-align:center;margin:10px 0;}
input,button{padding:10px;margin:5px;border-radius:6px;border:1px solid #ccc;font-size:16px;}
button{cursor:pointer;background:#0084ff;color:white;border:none;}
button:hover{background:#0066cc;}
.topbar{width:100%;display:flex;justify-content:center;align-items:center;position:relative;margin-bottom:10px;}
.back{padding:8px 16px;border-radius:20px;color:white;border:none;cursor:pointer;background:#555;}
.back:hover{background:#333;}
#messages{flex:1;width:100%;overflow-y:auto;background:rgba(255,255,255,0.8);border-radius:10px;padding:10px;margin-bottom:0;}
.message{display:inline-block;clear:both;margin:6px 0;padding:10px;border-radius:15px;max-width:70%;word-wrap:break-word;font-family:'Minecraft',Arial;position:relative;}
.message strong{color:#0084ff;}
.from-me{background:#cfe9ff;float:right;}
.from-others{background:#e9ecef;float:left;}
#audioMsg{width:100%;margin-top:5px;}
#input-area{display:flex;width:100%;border-top:1px solid #ddd;padding:10px;background:rgba(255,255,255,0.95);}
#messageInput{flex:1;border-radius:20px;padding:10px 15px;border:1px solid #ccc;font-size:16px;}
#sendBtn{width:50px;margin-left:10px;border-radius:50%;font-size:20px;}
#voiceMsgBtn{margin-left:5px;font-size:20px;border-radius:50%;background:#0084ff;width:40px;height:40px;padding:0;display:flex;align-items:center;justify-content:center;}
.emojiPicker{display:flex;gap:5px;margin-top:5px;flex-wrap:wrap;justify-content:center;}
.emojiPicker img{width:40px;height:40px;cursor:pointer;}
.menuBtn{padding:10px 15px;width:90%;margin:5px;text-align:center;border-radius:12px;background:#0084ff;color:white;}
.menuBtn:hover{background:#0066cc;}
#menuGreetingWrapper{display:flex;flex-direction:column;align-items:center;margin-bottom:10px;}
#menuGreeting{margin-bottom:10px;}
.menuActions{display:flex;gap:10px;margin-top:10px;justify-content:center;}
.privateChatLink{display: block; width: 90%; padding: 10px; margin: 5px; text-align: center; border-radius: 6px; background: #e0e0e0; color: #333; cursor: pointer; border: 1px solid #ccc;}
.privateChatLink:hover{background: #d0d0d0;}
@media(max-width:500px){.screen{width:95%;padding:10px;}#input-area{padding:5px;}#messageInput{font-size:14px;padding:8px;}}
</style>
</head>
<body>

<div id='authScreen' class='screen'>
    <h2>–ó—î—Ñ–∞–ë–æ—Ç+ (–ú—ñ—Å—Ç—Ä–∞–ª)</h2>
    <input type='text' id='username' placeholder='–í–≤–µ–¥—ñ—Ç—å —é–∑—î—Ä–Ω–∞–º—î (–ª—é–±–µ)'>
    <button id='loginBtn'>–í–≤—ñ–π—Ç—ñ</button>
    <button id='backAuth' class='back'>‚¨Ö –ù–∞–∑–∞–¥</button>
</div>

<div id='menuScreen' class='screen'>
    <div id='menuGreetingWrapper'>
        <h2 id='menuGreeting'></h2>
    </div>
    <button class='menuBtn' id='publicChatBtn'>–û–±—â—ñ–π —á–∞—Ç (–ó—î—Ñ–∞–ë–æ—Ç)</button>
    <button class='menuBtn' id='privateChatsBtn'>–ü—Ä—ñ–≤–∞—Ç–Ω—ñ —á–∞—Ç–∏</button>
    <button class='menuBtn' id='createPrivateBtn'>–°—Ç–≤–æ—Ä–∏—Ç–∏ –ø—Ä—ñ–≤–∞—Ç–Ω–∏–π —á–∞—Ç</button>
    <button class='menuBtn' onclick="alert('–£–≤—ñ–¥–∞–º–ª—î–Ω—ñ—è –Ω—î —Ä–æ–±–ª—è—Ç—å. –Ø –ª–æ—Ö!')">üîî –í–∫–ª—é—á–∏—Ç–∏ —É–≤—ñ–¥–∞–º–ª—î–Ω—ñ—è</button>
    <div class='menuActions'>
        <button id='logoutMenu' class='back'>–í–∏–π—Ç—ñ</button>
        <button id='backMenu' class='back'>‚¨Ö –ù–∞–∑–∞–¥ –¥–æ –º–µ–Ω—é</button>
    </div>
</div>

<div id='chatScreen' class='screen'>
    <div class='topbar'>
        <h2 id='chatTitle'></h2>
    </div>
    <div id='messages'></div>
    <div id='input-area'>
        <input type='text' id='messageInput' placeholder='–ü–Ü–®–ò!!!'>
        <button id='sendBtn'>‚Üí</button>
        <button id='voiceMsgBtn' onclick="alert('–ê—É–¥—ñ–æ–ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –Ω—î —Ä–æ–±–ª—è—Ç—å!')">üéôÔ∏è</button>
    </div>
    <div class='emojiPicker' id='emojiPicker'>
        <img src='zefasticker1.png' data-sticker-text='–Ø —Ç—ñ–ø–∞ —Å—Ç—ñ–∫–µ—Ä #1'>
        <img src='zefasticker2.png' data-sticker-text='–Ø —Ç—ñ–ø–∞ —Å—Ç—ñ–∫–µ—Ä #2'>
        <img src='zefasticker3.png' data-sticker-text='–Ø —Ç—ñ–ø–∞ —Å—Ç—ñ–∫–µ—Ä #3'>
        <img src='zefasticker4.png' data-sticker-text='–Ø —Ç—ñ–ø–∞ —Å—Ç—ñ–∫–µ—Ä #4'>
        <img src='zefasticker5.png' data-sticker-text='–Ø —Ç—ñ–ø–∞ —Å—Ç—ñ–∫–µ—Ä #5'>
        <img src='zefasticker6.png' data-sticker-text='–Ø —Ç—ñ–ø–∞ —Å—Ç—ñ–∫–µ—Ä #6'>
        <img src='zefasticker7.png' data-sticker-text='–Ø —Ç—ñ–ø–∞ —Å—Ç—ñ–∫–µ—Ä #7'>
    </div>
    <div class='menuActions'>
        <button id='clearMemBtn' class='back' style='background: red;'>/clear_mem</button>
        <button id='backChat' class='back'>‚¨Ö –ù–∞–∑–∞–¥</button>
    </div>
</div>

<div id='privateChatsScreen' class='screen' style='display:none;'>
    <h2>–ü—Ä—ñ–≤–∞—Ç–Ω—ñ —á–∞—Ç–∏</h2>
    <div id='privateChatsList' style='width:100%; flex: 1; overflow-y: auto;'></div>
    <div class='menuActions'>
        <button id='backPrivateChats' class='back'>‚¨Ö –ù–∞–∑–∞–¥</button>
    </div>
</div>

<script>
const BOT_NAME = '–ó—î—Ñ–∞–ë–æ—Ç';
// >>> –í–ê–ñ–õ–ò–í–û: –ó–ê–ú–Ü–ù–ò –¶–ï–ô URL –ù–ê –ê–î–†–ï–°–£ –°–í–û–ì–û –†–û–ó–ì–û–†–ù–£–¢–û–ì–û DJANGO –ë–ï–ö–ï–ù–î–£! <<<
const PROXY_BASE_URL = 'YOUR_DJANGO_DEPLOYMENT_URL/api/'; 

let currentUser = localStorage.getItem('currentUser') || null;
let currentChat = 'public'; 
let userChats = JSON.parse(localStorage.getItem('userChats_' + currentUser)) || { 'public': BOT_NAME }; 
let chatHistory = JSON.parse(localStorage.getItem('chatHistory_' + currentUser)) || {};

const authScreen = document.getElementById('authScreen');
const menuScreen = document.getElementById('menuScreen');
const chatScreen = document.getElementById('chatScreen');
const privateChatsScreen = document.getElementById('privateChatsScreen');
const usernameInput = document.getElementById('username');
const messagesDiv = document.getElementById('messages');
const messageInput = document.getElementById('messageInput');
const menuGreeting = document.getElementById('menuGreeting');
const privateChatsList = document.getElementById('privateChatsList');

function formatTime(date){
    const h = String(date.getHours()).padStart(2, '0');
    const m = String(date.getMinutes()).padStart(2, '0');
    return `${h}:${m}`;
}

function showScreen(screenId) {
    const screens = [authScreen, menuScreen, chatScreen, privateChatsScreen];
    screens.forEach(screen => {
        screen.style.display = (screen.id === screenId) ? 'flex' : 'none';
    });
}

function showMenu(show){
    showScreen(show ? 'menuScreen' : 'authScreen');
    if(show) menuGreeting.textContent = `–ü—Ä—ñ–≤—î—Ç, –¥—É—Ä–∞ ${currentUser}!`;
}

function getChatKey() {
    return currentChat;
}

function showChat(chatName, title) {
    currentChat = chatName;
    messagesDiv.innerHTML = '';
    
    const history = chatHistory[getChatKey()] || [];
    history.forEach(msg => renderMessage(msg.user, msg.text, msg.user === currentUser));

    showScreen('chatScreen');
    document.getElementById('chatTitle').textContent = title;
}

function renderMessage(user, text, isMe) {
    const d = document.createElement('div');
    d.className = 'message ' + (isMe ? 'from-me' : 'from-others');
    
    let formattedText;
    if (text.startsWith('–Ø —Ç—ñ–ø–∞ —Å—Ç—ñ–∫–µ—Ä')) {
        const stickerNumber = text.split('#')[1];
        formattedText = `<img src='zefasticker${stickerNumber.trim()}.png' style='width:50px;height:50px'>`;
    } else {
        formattedText = text
            .replace(/\*\*(.*?)\*\*/g, '<b>$1</b>')
            .replace(/\*(.*?)\*/g, '<i>$1</i>')
            .replace(/\n/g, '<br>');
    }
    
    d.innerHTML = `<strong>${user}</strong>: ${formattedText} <small>(${formatTime(new Date())}</small>`;
    
    messagesDiv.appendChild(d);
    messagesDiv.scrollTop = messagesDiv.scrollHeight;
}

function saveMessage(chatName, user, text) {
    if (!chatHistory[chatName]) chatHistory[chatName] = [];
    chatHistory[chatName].push({user, text});
    localStorage.setItem('chatHistory_' + currentUser, JSON.stringify(chatHistory));
}

function login(){
    const u = usernameInput.value.trim();
    if(!u) return alert('–í–≤—î–¥—ñ —é–∑—î—Ä–Ω–∞–º—î, –±–∞–ª–±—î—Å');
    currentUser = u;
    localStorage.setItem('currentUser', u);
    
    userChats = JSON.parse(localStorage.getItem('userChats_' + currentUser)) || { 'public': BOT_NAME };
    chatHistory = JSON.parse(localStorage.getItem('chatHistory_' + currentUser)) || {};
    
    showMenu(true);
}

function logout(){
    localStorage.removeItem('currentUser');
    currentUser = null;
    showScreen('authScreen');
}

function showPrivateChats() {
    showScreen('privateChatsScreen');
    privateChatsList.innerHTML = '';
    
    let hasPrivateChats = false;
    for (const chatName in userChats) {
        if (chatName !== 'public') {
            hasPrivateChats = true;
            const partnerName = userChats[chatName];
            const d = document.createElement('button');
            d.className = 'privateChatLink';
            d.textContent = `–ë–∞–∑–∞—Ä –∑: ${partnerName}`;
            d.onclick = () => showChat(chatName, partnerName);
            privateChatsList.appendChild(d);
        }
    }
    
    if (!hasPrivateChats) {
        privateChatsList.innerHTML = '<p style=\'text-align: center; margin-top: 20px;\'>–£ —Ç–µ–±–µ –Ω–µ–º–∞ –ø—Ä—ñ–≤–∞—Ç–Ω–∏—Ö –±–∞–∑–∞—Ä—ñ–≤, –ª–æ—Ö.</p>';
    }
}

function createPrivateChat() {
    const partner = prompt('–í–≤—î–¥—ñ—Ç—î —é–∑—î—Ä–Ω–∞–º—î —Å–ø—ñ–≤—Ä–æ–∑–º–æ–≤–Ω–∏–∫–∞:');
    if (!partner || partner.trim() === currentUser || partner.trim() === BOT_NAME) {
        return alert('–ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–∏–π —é–∑—î—Ä–Ω–∞–º—î.');
    }
    const cleanPartner = partner.trim();
    const chatID = 'private_' + cleanPartner;
    
    if (userChats[chatID]) {
        return alert(`–¢–∏ –≤–∂–µ –±–∞–∑–∞—Ä–∏—à –∑ ${cleanPartner}.`);
    }

    userChats[chatID] = cleanPartner;
    localStorage.setItem('userChats_' + currentUser, JSON.stringify(userChats));

    alert(`–°—Ç–≤–æ—Ä–µ–Ω–æ –±–∞–∑–∞—Ä –∑ ${cleanPartner}!`);
    showChat(chatID, cleanPartner);
}

async function sendMessage(text = messageInput.value) {
    const t = text.trim();
    if (!t || !currentUser) return;
    
    renderMessage(currentUser, t, true);
    saveMessage(currentChat, currentUser, t);
    messageInput.value = '';

    if (currentChat !== 'public') {
        setTimeout(() => {
            renderMessage(userChats[currentChat], '–¢–∏ –∑ –∫–∏–º–æ—Å—å –±–∞–∑–∞—Ä–∏—à? –¢—É—Ç —Ç—ñ–ª—å–∫–∏ —Ç–∏ —î.', false);
            saveMessage(currentChat, userChats[currentChat], '–¢–∏ –∑ –∫–∏–º–æ—Å—å –±–∞–∑–∞—Ä–∏—à? –¢—É—Ç —Ç—ñ–ª—å–∫–∏ —Ç–∏ —î.');
        }, 2000);
        return;
    }
    
    const messagesToSend = (chatHistory[getChatKey()] || []).map(msg => ({
        role: msg.user === BOT_NAME ? 'assistant' : 'user',
        content: msg.text
    }));
    
    const isFirstMessage = messagesToSend.filter(msg => msg.role !== 'system').length <= 1;

    try {
        const response = await fetch(PROXY_BASE_URL + 'chat/', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ 
                user_id: currentUser,
                messages: messagesToSend,
                is_first_message: isFirstMessage
            })
        });

        const data = await response.json();
        
        if (data.reply) {
            const reply = data.reply;
            renderMessage(BOT_NAME, reply, false);
            saveMessage(currentChat, BOT_NAME, reply);
        } else {
            const errorMsg = data.error || '–ó—î—Ñ–∞–ë–æ—Ç –∑–ª–∞–º–∞–≤—Å—è! –ê—à–∏–±–∫–∞ –ø—Ä–æ–∫—Å—ñ.';
            renderMessage(BOT_NAME, `**–ü–æ–º–∏–ª–∫–∞:** ${errorMsg}`, false);
        }

    } catch(e) {
        renderMessage(BOT_NAME, `**–ö—Ä–∏—Ç–∏—á–Ω–∞ –ø–æ–º–∏–ª–∫–∞ –º–µ—Ä–µ–∂—ñ:** –ó—î—Ñ–∞–ë–æ—Ç –Ω–µ –¥–æ—Å—Ç—É–∫–∞–≤—Å—è –¥–æ API. ${e.message}`, false);
        console.error('Chat error:', e);
    }
}

async function clearMemory() {
    if (!currentUser) return alert('–¢—Ä–µ–±–∞ –≤–≤—ñ–π—Ç—ñ, –¥—É—Ä–∏–∫!');
    
    if (confirm('–¢–æ—á–Ω–æ —Å—Ç–µ—Ä—Ç–∏ –ø–∞–º\'—è—Ç—å –ó—î—Ñ–∞–ë–æ—Ç–∞ (—ñ —ñ—Å—Ç–æ—Ä—ñ—é –ø–æ—Ç–æ—á–Ω–æ–≥–æ —á–∞—Ç—É)?')) {
        
        delete chatHistory[getChatKey()];
        localStorage.setItem('chatHistory_' + currentUser, JSON.stringify(chatHistory));

        if (currentChat === 'public') {
            try {
                const response = await fetch(PROXY_BASE_URL + 'clear_mem/', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ user_id: currentUser })
                });
                const data = await response.json();
                
                messagesDiv.innerHTML = ''; 
                alert(data.reply || '–£ –º—î–Ω—è –∞–º–Ω–µ–∑—ñ—è –±–µ–∑ –≤—ñ–¥–Ω–æ–≤–ª–µ–Ω–Ω—è –ø–∞–º—ñ—Ç—ñ. –ë–µ–±–µ.');
            } catch (e) {
                 alert('–ü–æ–º–∏–ª–∫–∞ –æ—á–∏—â–µ–Ω–Ω—è –ø–∞–º‚Äô—è—Ç—ñ –Ω–∞ –±–µ–∫–µ–Ω–¥—ñ. –õ–æ–∫–∞–ª—å–Ω–∏–π —á–∞—Ç —Å–∫–∏–Ω—É—Ç–æ.');
            }
        } else {
             messagesDiv.innerHTML = ''; 
             alert('–£ –º—î–Ω—è –∞–º–Ω–µ–∑—ñ—è –±–µ–∑ –≤—ñ–¥–Ω–æ–≤–ª–µ–Ω–Ω—è –ø–∞–º—ñ—Ç—ñ. –ë–µ–±–µ.');
        }
    }
}

document.getElementById('loginBtn').onclick = login;
document.getElementById('logoutMenu').onclick = logout;
document.getElementById('backChat').onclick = () => showMenu(true);
document.getElementById('publicChatBtn').onclick = () => showChat('public', '–ó—î—Ñ–∞–ë–æ—Ç (–û–±—â—ñ–π —á–∞—Ç)');
document.getElementById('sendBtn').onclick = () => sendMessage();
document.getElementById('clearMemBtn').onclick = clearMemory;
document.getElementById('backPrivateChats').onclick = () => showMenu(true);

document.getElementById('privateChatsBtn').onclick = showPrivateChats;
document.getElementById('createPrivateBtn').onclick = createPrivateChat;

messageInput.addEventListener('keydown', (e) => {
    if (e.key === 'Enter') {
        e.preventDefault();
        sendMessage();
    }
});

document.querySelectorAll('.emojiPicker img').forEach(i => i.onclick = e => {
    sendMessage(e.target.getAttribute('data-sticker-text'));
});

document.getElementById('backMenu').onclick = () => window.location.href='../index.html';
document.getElementById('backAuth').onclick = () => window.location.href='../index.html';

window.onload = () => {
    if (currentUser) {
        userChats = JSON.parse(localStorage.getItem('userChats_' + currentUser)) || { 'public': BOT_NAME };
        chatHistory = JSON.parse(localStorage.getItem('chatHistory_' + currentUser)) || {};
        showMenu(true);
    } else {
        showScreen('authScreen');
    }
};
</script>
</body>
</html>
