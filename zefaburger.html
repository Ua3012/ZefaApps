<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Minecraft HTML Touch</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three/examples/js/controls/OrbitControls.js"></script>

    <style>
        body { margin: 0; overflow: hidden; background-color: #87ceeb; }
        canvas { display: block; }

        /* –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è —Å–µ–Ω—Å–æ—Ä–Ω–æ–≥–æ –∫–µ—Ä—É–≤–∞–Ω–Ω—è */
        #touchControls {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none; /* –î–æ–∑–≤–æ–ª—è—î –∫–ª—ñ–∫–∞–º –ø—Ä–æ—Ö–æ–¥–∏—Ç–∏ –∑–∞ –∑–∞–º–æ–≤—á—É–≤–∞–Ω–Ω—è–º */
        }

        /* –í—ñ—Ä—Ç—É–∞–ª—å–Ω–∏–π –¥–∂–æ–π—Å—Ç–∏–∫ (—Ä—É—Ö) */
        #movementPad {
            pointer-events: auto;
            position: absolute;
            bottom: 5vh;
            left: 5vw;
            width: 15vh;
            height: 15vh;
            border-radius: 50%;
            background-color: rgba(255, 255, 255, 0.2);
            display: flex;
            justify-content: center;
            align-items: center;
            opacity: 0.8;
            touch-action: none; /* –ó–∞–ø–æ–±—ñ–≥–∞—î –±—Ä–∞—É–∑–µ—Ä–Ω–æ–º—É —Å–∫—Ä–æ–ª—ñ–Ω–≥—É */
        }

        .joystick-handle {
            width: 6vh;
            height: 6vh;
            border-radius: 50%;
            background-color: rgba(255, 255, 255, 0.6);
            transform: translate(0, 0);
            touch-action: none;
        }

        /* –ö–Ω–æ–ø–∫–∏ –¥—ñ–π */
        #actionButtons {
            position: absolute;
            bottom: 5vh;
            right: 5vw;
            display: flex;
            flex-direction: column;
            gap: 2vh;
        }

        .action-btn {
            pointer-events: auto;
            width: 12vh;
            height: 12vh;
            border-radius: 50%;
            border: 0.5vh solid #fff;
            background-color: rgba(0, 0, 0, 0.5);
            color: #fff;
            font-size: 2.5vh;
            font-family: sans-serif;
            font-weight: bold;
            user-select: none;
            cursor: pointer;
            -webkit-tap-highlight-color: transparent;
            text-align: center;
            line-height: 12vh;
        }
    </style>
</head>
<body>
    <div id="touchControls">
        <div id="movementPad">
            <div class="joystick-handle"></div>
        </div>

        <div id="actionButtons">
            <div id="placeBlockButton" class="action-btn">üß±</div>
            <div id="breakBlockButton" class="action-btn">‚õèÔ∏è</div>
        </div>
    </div>

    <script>
        // === –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è THREE.js ===
        let scene, camera, renderer;
        let blocks = [];
        const blockSize = 1;
        const speed = 0.05;

        function init() {
            // –°—Ü–µ–Ω–∞
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x87ceeb); // –°–≤—ñ—Ç–ª–æ-–±–ª–∞–∫–∏—Ç–Ω–µ –Ω–µ–±–æ

            // –ö–∞–º–µ—Ä–∞ (–ü–µ—Ä—Å–ø–µ–∫—Ç–∏–≤–∞)
            camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
            camera.position.set(0, 1.6, 5); // –ü–æ–∑–∏—Ü—ñ—è –≥—Ä–∞–≤—Ü—è (–ø—Ä–∏–±–ª–∏–∑–Ω–æ 1.6–º –≤–∏—Å–æ—Ç–∞)

            // –†–µ–Ω–¥–µ—Ä–µ—Ä
            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            document.body.appendChild(renderer.domElement);

            // –°–≤—ñ—Ç–ª–æ
            const ambientLight = new THREE.AmbientLight(0x404040, 5);
            scene.add(ambientLight);

            // –ì–µ–Ω–µ—Ä–∞—Ü—ñ—è –ø—Ä–æ—Å—Ç–æ–≥–æ “ë—Ä—É–Ω—Ç—É (–ø–ª–æ—â–∏–Ω–∞)
            createBlock(0, 0, 0, 'grass');
            createBlock(blockSize, 0, 0, 'grass');
            createBlock(-blockSize, 0, 0, 'grass');
            createBlock(0, 0, blockSize, 'grass');
            
            // –°—Ç–≤–æ—Ä–µ–Ω–Ω—è —Ç–µ—Å—Ç–æ–≤–æ–≥–æ –±–ª–æ–∫—É
            createBlock(3, 1, 3, 'stone');

            // –û–±—Ä–æ–±–∫–∞ –∑–º—ñ–Ω–∏ —Ä–æ–∑–º—ñ—Ä—É –≤—ñ–∫–Ω–∞
            window.addEventListener('resize', onWindowResize, false);

            // –ó–∞–ø—É—Å–∫–∞—î–º–æ —ñ–≥—Ä–æ–≤–∏–π —Ü–∏–∫–ª
            animate();
        }

        function createBlock(x, y, z, type) {
            let color;
            switch (type) {
                case 'grass': color = 0x228B22; break; // –¢–µ–º–Ω–æ-–∑–µ–ª–µ–Ω–∏–π
                case 'stone': color = 0x808080; break; // –°—ñ—Ä–∏–π
                default: color = 0xff0000;
            }

            const geometry = new THREE.BoxGeometry(blockSize, blockSize, blockSize);
            const material = new THREE.MeshLambertMaterial({ color: color });
            const block = new THREE.Mesh(geometry, material);
            
            // –í–∏—Ä—ñ–≤–Ω—é—î–º–æ –ø–æ–∑–∏—Ü—ñ—é –ø–æ —Ü–µ–Ω—Ç—Ä–∞—Ö –±–ª–æ–∫—ñ–≤ (–∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∏ –º–∞—é—Ç—å –±—É—Ç–∏ –∫—Ä–∞—Ç–Ω—ñ blockSize)
            block.position.set(x * blockSize, y * blockSize + blockSize / 2, z * blockSize);
            block.userData.type = type; // –î–æ–¥–∞—î–º–æ –¥–∞–Ω—ñ –¥–ª—è –≤–∑–∞—î–º–æ–¥—ñ—ó
            scene.add(block);
            blocks.push(block);
        }
        
        function onWindowResize() {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        }

        // === –Ü–≥—Ä–æ–≤–∞ –õ–æ–≥—ñ–∫–∞ —Ç–∞ –†–µ–Ω–¥–µ—Ä ===
        const tempVector = new THREE.Vector3();
        let playerVelocity = new THREE.Vector3();
        let isMoving = { forward: false, backward: false, left: false, right: false };
        let yaw = 0; // –û–±–µ—Ä—Ç–∞–Ω–Ω—è –∫–∞–º–µ—Ä–∏ –ø–æ –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—ñ
        let pitch = 0; // –û–±–µ—Ä—Ç–∞–Ω–Ω—è –∫–∞–º–µ—Ä–∏ –ø–æ –≤–µ—Ä—Ç–∏–∫–∞–ª—ñ (–Ω–µ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î—Ç—å—Å—è –¥–ª—è –ø—Ä–æ—Å—Ç–æ—Ç–∏)

        function animate() {
            requestAnimationFrame(animate);

            // –û–±—Ä–æ–±–∫–∞ —Ä—É—Ö—É –≥—Ä–∞–≤—Ü—è –Ω–∞ –æ—Å–Ω–æ–≤—ñ –¥–∂–æ–π—Å—Ç–∏–∫–∞
            playerVelocity.set(0, 0, 0);

            // –í–∏–∑–Ω–∞—á–∞—î–º–æ –Ω–∞–ø—Ä—è–º–æ–∫ —Ä—É—Ö—É –Ω–∞ –æ—Å–Ω–æ–≤—ñ –ø–æ—Ç–æ—á–Ω–æ–≥–æ –æ–≥–ª—è–¥—É (yaw)
            const forwardVector = new THREE.Vector3(0, 0, -1).applyAxisAngle(new THREE.Vector3(0, 1, 0), yaw);
            const sideVector = new THREE.Vector3(1, 0, 0).applyAxisAngle(new THREE.Vector3(0, 1, 0), yaw);

            if (isMoving.forward) playerVelocity.add(forwardVector);
            if (isMoving.backward) playerVelocity.sub(forwardVector);
            if (isMoving.left) playerVelocity.sub(sideVector);
            if (isMoving.right) playerVelocity.add(sideVector);

            playerVelocity.normalize().multiplyScalar(speed);

            camera.position.add(playerVelocity);

            // –ó–∞—Å—Ç–æ—Å—É–≤–∞–Ω–Ω—è –æ–≥–ª—è–¥—É
            camera.rotation.y = yaw; 
            
            renderer.render(scene, camera);
        }

        // === –õ–û–ì–Ü–ö–ê –°–ï–ù–°–û–†–ù–û–ì–û –ö–ï–†–£–í–ê–ù–ù–Ø ===

        // 1. –£–ø—Ä–∞–≤–ª—ñ–Ω–Ω—è —Ä—É—Ö–æ–º (–î–∂–æ–π—Å—Ç–∏–∫)
        const movementPad = document.getElementById('movementPad');
        const joystickHandle = movementPad.querySelector('.joystick-handle');
        const padCenter = movementPad.clientWidth / 2;
        const maxDistance = padCenter * 0.7;
        let movementTouchId = null;

        movementPad.addEventListener('touchstart', (e) => {
            e.preventDefault();
            if (movementTouchId === null) {
                movementTouchId = e.changedTouches[0].identifier;
                handleJoystickMove(e.changedTouches[0]);
            }
        });

        document.addEventListener('touchmove', (e) => {
            for (let i = 0; i < e.changedTouches.length; i++) {
                const touch = e.changedTouches[i];
                if (touch.identifier === movementTouchId) {
                    handleJoystickMove(touch);
                    return;
                }
            }
        }, { passive: false });

        document.addEventListener('touchend', (e) => {
            for (let i = 0; i < e.changedTouches.length; i++) {
                if (e.changedTouches[i].identifier === movementTouchId) {
                    resetJoystick();
                    return;
                }
            }
        });

        function handleJoystickMove(touch) {
            const rect = movementPad.getBoundingClientRect();
            let x = touch.clientX - rect.left - padCenter;
            let y = touch.clientY - rect.top - padCenter;

            const distance = Math.sqrt(x * x + y * y);
            if (distance > maxDistance) {
                const angle = Math.atan2(y, x);
                x = Math.cos(angle) * maxDistance;
                y = Math.sin(angle) * maxDistance;
            }

            joystickHandle.style.transform = `translate(${x}px, ${y}px)`;

            // –í–∏–∑–Ω–∞—á–µ–Ω–Ω—è –Ω–∞–ø—Ä—è–º–∫—É —Ä—É—Ö—É (–∑–∞–ª–µ–∂–∏—Ç—å –≤—ñ–¥ Y)
            const threshold = maxDistance * 0.3; 
            isMoving.forward = y < -threshold;
            isMoving.backward = y > threshold;
            isMoving.left = x < -threshold;
            isMoving.right = x > threshold;
        }

        function resetJoystick() {
            movementTouchId = null;
            joystickHandle.style.transform = `translate(0, 0)`;
            isMoving = { forward: false, backward: false, left: false, right: false };
        }

        // 2. –£–ø—Ä–∞–≤–ª—ñ–Ω–Ω—è –æ–≥–ª—è–¥–æ–º (–°–≤–∞–π–ø –ø–æ —Ä–µ—à—Ç—ñ –µ–∫—Ä–∞–Ω—É)
        let lookTouchId = null;
        let lastTouchX = null;
        let lookSensitivity = 0.005; // –ß—É—Ç–ª–∏–≤—ñ—Å—Ç—å –æ–≥–ª—è–¥—É

        document.addEventListener('touchstart', (e) => {
            for (let i = 0; i < e.changedTouches.length; i++) {
                const touch = e.changedTouches[i];
                // –Ø–∫—â–æ –¥–æ—Ç–∏–∫ –ù–ï –Ω–∞ –µ–ª–µ–º–µ–Ω—Ç—ñ –∫–µ—Ä—É–≤–∞–Ω–Ω—è (–¥–∂–æ–π—Å—Ç–∏–∫ –∞–±–æ –∫–Ω–æ–ø–∫–∏)
                if (!touch.target.closest('#touchControls')) {
                    if (lookTouchId === null) {
                        lookTouchId = touch.identifier;
                        lastTouchX = touch.clientX;
                        // –¢—É—Ç –º–æ–∂–Ω–∞ —Ç–∞–∫–æ–∂ —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑—É–≤–∞—Ç–∏ lastTouchY –¥–ª—è –æ–≥–ª—è–¥—É –≤–≥–æ—Ä—É/–≤–Ω–∏–∑
                    }
                }
            }
        });

        document.addEventListener('touchmove', (e) => {
            for (let i = 0; i < e.changedTouches.length; i++) {
                const touch = e.changedTouches[i];
                if (touch.identifier === lookTouchId) {
                    const deltaX = touch.clientX - lastTouchX;
                    
                    // –û–Ω–æ–≤–ª–µ–Ω–Ω—è –æ–≥–ª—è–¥—É –ø–æ –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—ñ
                    yaw -= deltaX * lookSensitivity;

                    lastTouchX = touch.clientX;
                    return;
                }
            }
        }, { passive: false });

        document.addEventListener('touchend', (e) => {
            for (let i = 0; i < e.changedTouches.length; i++) {
                if (e.changedTouches[i].identifier === lookTouchId) {
                    lookTouchId = null;
                    lastTouchX = null;
                    return;
                }
            }
        });

        // 3. –ö–Ω–æ–ø–∫–∏ –≤–∑–∞—î–º–æ–¥—ñ—ó
        const placeButton = document.getElementById('placeBlockButton');
        const breakButton = document.getElementById('breakBlockButton');
        const raycaster = new THREE.Raycaster();

        // –§—É–Ω–∫—Ü—ñ—è –¥–ª—è –≤–∏–∑–Ω–∞—á–µ–Ω–Ω—è, –Ω–∞ —è–∫–∏–π –±–ª–æ–∫ –º–∏ –¥–∏–≤–∏–º–æ—Å—è
        function getIntersectedBlock() {
            // –í—Å—Ç–∞–Ω–æ–≤–ª—é—î–º–æ –ø—Ä–æ–º—ñ–Ω—å –≤—ñ–¥ —Ü–µ–Ω—Ç—Ä—É –µ–∫—Ä–∞–Ω—É (–∫–∞–º–µ—Ä–∏)
            raycaster.setFromCamera({ x: 0, y: 0 }, camera);
            
            // –§—ñ–ª—å—Ç—Ä—É—î–º–æ –æ–±'—î–∫—Ç–∏, —â–æ–± –ø–µ—Ä–µ–≤—ñ—Ä—è—Ç–∏ –ª–∏—à–µ –±–ª–æ–∫–∏
            const intersects = raycaster.intersectObjects(blocks, false);
            return intersects.length > 0 ? intersects[0] : null;
        }

        placeButton.addEventListener('touchstart', (e) => {
            e.preventDefault();
            const intersection = getIntersectedBlock();
            if (intersection) {
                // –†–æ–∑–º—ñ—â–µ–Ω–Ω—è –±–ª–æ–∫—É
                const newPosition = intersection.point.add(intersection.face.normal).floor().addScalar(0.5);
                createBlock(newPosition.x - 0.5, newPosition.y - 0.5, newPosition.z - 0.5, 'stone');
            }
        });

        breakButton.addEventListener('touchstart', (e) => {
            e.preventDefault();
            const intersection = getIntersectedBlock();
            if (intersection) {
                // –í–∏–¥–∞–ª–µ–Ω–Ω—è –±–ª–æ–∫—É (–ø–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ, —á–∏ —Ü–µ –Ω–µ “ë—Ä—É–Ω—Ç)
                if (intersection.object.userData.type !== 'grass') {
                    scene.remove(intersection.object);
                    blocks = blocks.filter(b => b !== intersection.object);
                    intersection.object.geometry.dispose();
                    intersection.object.material.dispose();
                }
            }
        });

        // –ó–∞–ø—É—Å–∫ –≥—Ä–∏
        init();
    </script>
</body>
</html>
