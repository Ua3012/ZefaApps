<!DOCTYPE html>
<html lang='uk'>
<head>
    <meta charset='UTF-8'>
    <title>–ó—î—Ñ–∞–ë—ñ—Ä–∂–∞ - –°–ø–æ—Ç ZFC/Stars</title>
    <script src='https://telegram.org/js/telegram-web-app.js'></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: var(--tg-theme-bg-color, #1a1a2e); 
            color: var(--tg-theme-text-color, #ffffff);
            margin: 0;
            padding: 10px;
            text-align: center;
        }
        .container {
            max-width: 420px;
            margin: 0 auto;
        }
        .balance-info {
            background-color: var(--tg-theme-secondary-bg-color, #2a2a4a);
            padding: 15px;
            border-radius: 12px;
            margin-bottom: 15px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }
        .price-display {
            font-size: 2.2em;
            font-weight: bold;
            color: #4CAF50;
            transition: color 0.5s;
        }
        .chart-mockup {
            height: 150px;
            background-color: #333366;
            margin: 15px 0;
            border-radius: 8px;
            position: relative;
        }
        .chart-mockup::before {
            content: '–ì—Ä–∞—Ñ—ñ–∫ ZFC/Stars (–Ü–º—ñ—Ç–∞—Ü—ñ—è —Ä–µ–∞–ª—å–Ω–∏—Ö –∫–æ–ª–∏–≤–∞–Ω—å)...';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: #8f8f8f;
            font-size: 0.9em;
        }
        .trade-panel {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }
        .trade-box {
            background-color: var(--tg-theme-secondary-bg-color, #2a2a4a);
            padding: 15px;
            border-radius: 12px;
            flex-grow: 1;
            text-align: left;
        }
        .trade-box h4 {
            margin-top: 0;
            color: var(--tg-theme-hint-color, #ff9900);
            text-align: center;
        }
        input[type='number'] {
            width: 90%;
            padding: 10px 5px;
            margin-bottom: 10px;
            border-radius: 6px;
            border: 1px solid #4a4a8f;
            background-color: var(--tg-theme-bg-color, #1a1a2e);
            color: var(--tg-theme-text-color, #ffffff);
            font-size: 1em;
            text-align: center;
        }
        button {
            width: 100%;
            padding: 12px;
            border: none;
            border-radius: 6px;
            font-weight: bold;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        .buy-btn {
            background-color: #4CAF50;
            color: #fff;
        }
        .sell-btn {
            background-color: #F44336;
            color: #fff;
        }
        .info-fee {
            font-size: 0.8em;
            color: #b0b0b0;
            margin-top: 5px;
            text-align: center;
        }
        .message-box {
            background-color: #333366;
            color: #ffffff;
            padding: 10px;
            border-radius: 8px;
            min-height: 20px;
            text-align: center;
        }
    </style>
</head>
<body>
    <div class='container'>
        <header class='header'>
            <h2>üíé –ó—î—Ñ–∞–ë—ñ—Ä–∂–∞ | –°–ø–æ—Ç ZFC/Stars</h2>
        </header>

        <section class='balance-info'>
            <h3>–í–∞—à –ë–∞–ª–∞–Ω—Å</h3>
            <p>Stars (–î–ª—è —Ç–æ—Ä–≥—ñ–≤): <span id='stars_balance'>0.00</span></p>
            <p>ZefaCoin (ZFC): <span id='zfc_balance'>0.00</span></p>
        </section>

        <section class='price-info'>
            <h3>–ü–æ—Ç–æ—á–Ω–∏–π –ö—É—Ä—Å ZFC/Stars</h3>
            <div class='price-display' id='current_price'>0.1000</div>
            <p>1 Stars = <span id='zfc_equivalent'>10.00</span> ZFC</p>
        </section>

        <section class='chart-mockup'></section>

        <div class='trade-panel'>
            <section class='trade-box'>
                <h4>–ö—É–ø–∏—Ç–∏ ZFC (–∑–∞ Stars)</h4>
                <input type='number' id='buy_stars_amount' placeholder='–ö—ñ–ª—å–∫—ñ—Å—Ç—å Stars' oninput='calculateTrade('buy')'>
                <p>–û—Ç—Ä–∏–º–∞—î—Ç–µ ZFC: <span id='buy_zfc_result'>0.00</span></p>
                <button class='buy-btn' onclick='executeTrade('buy')'>–ö–£–ü–ò–¢–ò</button>
                <div class='info-fee'>–ö–æ–º—ñ—Å—ñ—è –±—ñ—Ä–∂—ñ: 7%</div>
            </section>

            <section class='trade-box'>
                <h4>–ü—Ä–æ–¥–∞—Ç–∏ ZFC (–í–∏–≤—ñ–¥ Stars)</h4>
                <input type='number' id='sell_zfc_amount' placeholder='–ö—ñ–ª—å–∫—ñ—Å—Ç—å ZFC' oninput='calculateTrade('sell')'>
                <p>–û—Ç—Ä–∏–º–∞—î—Ç–µ Stars: <span id='sell_stars_result'>0.00</span></p>
                <button class='sell-btn' onclick='executeTrade('sell')'>–ü–†–û–î–ê–¢–ò</button>
                <div class='info-fee'>–ö–æ–º—ñ—Å—ñ—è –±—ñ—Ä–∂—ñ: 7%</div>
            </section>
        </div>
        
        <div class='message-box' id='status_message'>–ì–æ—Ç–æ–≤–Ω—ñ—Å—Ç—å –¥–æ —Ç–æ—Ä–≥—ñ–≤...</div>
    </div>

    <script>
        const FIREBASE_CONFIG = {
            apiKey: 'AIzaSyBp_RXjmWLfK0wX8sDb1d_VQogZgwzaNFA',
            authDomain: 'zefagram.firebaseapp.com',
            projectId: 'zefagram',
            storageBucket: 'zefagram.firebasestorage.app',
            messagingSenderId: '664999563847',
            appId: '1:664999563847:web:3051100a05bdb41dc59762'
        };

        const BOT_API_TOKEN = '8207127333:AAFfafzUC85YiRY5CTsqDbaHrcfJMlK6jes';
        const BOT_INVOICE_URL = '–í–°–¢–ê–í–¢–ï_URL_–í–ê–®–û–ì–û_–°–ï–†–í–ï–†–ê_–î–õ–Ø_–Ü–ù–í–û–ô–°–Ü–í';
        
        const FEE_RATE = 0.07;
        const BASE_RATE_STARS_PER_ZFC = 0.10;
        const ZFC_NAME = 'ZefaCoin';

        let currentPrice = BASE_RATE_STARS_PER_ZFC;
        let userBalance = { stars: 0.00, zfc: 0.00 };
        let userId = 'MOCK_USER_ID';

        if (Telegram.WebApp.initDataUnsafe && Telegram.WebApp.initDataUnsafe.user) {
            userId = Telegram.WebApp.initDataUnsafe.user.id;
        }

        async function initApp() {
            userBalance = { stars: 100.00, zfc: 5000.00 };
            updateUI();
        }

        async function fetchUserData(id) {
            
        }

        async function updateFirebaseBalance(id, newBalances) {
            
        }
        
        async function createStarsInvoice(starsAmount, title) {
            const response = await fetch(BOT_INVOICE_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ userId: userId, amount: starsAmount, title: title })
            });
            const data = await response.json();
            return data.invoiceUrl;
        }

        function updateUI() {
            const fluctuation = (Math.random() - 0.5) * 0.002; 
            currentPrice = Math.max(0.001, BASE_RATE_STARS_PER_ZFC + fluctuation).toFixed(4);
            
            const priceElement = document.getElementById('current_price');
            const oldPrice = parseFloat(priceElement.textContent);
            
            priceElement.textContent = currentPrice;
            if (currentPrice > oldPrice) {
                priceElement.style.color = '#4CAF50';
            } else if (currentPrice < oldPrice) {
                priceElement.style.color = '#F44336';
            }

            document.getElementById('stars_balance').textContent = userBalance.stars.toFixed(2);
            document.getElementById('zfc_balance').textContent = userBalance.zfc.toFixed(2);
            document.getElementById('zfc_equivalent').textContent = (1 / currentPrice).toFixed(2);
        }

        function calculateTrade(type) {
            const rate = parseFloat(currentPrice);

            if (type === 'buy') {
                const amount = parseFloat(document.getElementById('buy_stars_amount').value) || 0;
                const zfc_result = (amount / rate) * (1 - FEE_RATE);
                document.getElementById('buy_zfc_result').textContent = zfc_result.toFixed(2);
            } else if (type === 'sell') {
                const amount = parseFloat(document.getElementById('sell_zfc_amount').value) || 0;
                const stars_result = (amount * rate) * (1 - FEE_RATE);
                document.getElementById('sell_stars_result').textContent = stars_result.toFixed(2);
            }
        }

        async function executeTrade(type) {
            const messageBox = document.getElementById('status_message');
            messageBox.textContent = `–í–∏–∫–æ–Ω—É—î—Ç—å—Å—è –æ–ø–µ—Ä–∞—Ü—ñ—è ${type === 'buy' ? '–ö–£–ü–Ü–í–õ–Ü' : '–ü–†–û–î–ê–ñ–£'}...`;
            
            const rate = parseFloat(currentPrice);

            try {
                const transactionAmount = type === 'buy' 
                    ? parseFloat(document.getElementById('buy_stars_amount').value) 
                    : parseFloat(document.getElementById('sell_zfc_amount').value);

                if (isNaN(transactionAmount) || transactionAmount <= 0) throw new Error('–í–≤–µ–¥—ñ—Ç—å –∫–æ—Ä–µ–∫—Ç–Ω—É —Å—É–º—É.');

                if (type === 'buy') {
                    if (userBalance.stars < transactionAmount) throw new Error('–ù–µ–¥–æ—Å—Ç–∞—Ç–Ω—å–æ Stars –Ω–∞ –±–∞–ª–∞–Ω—Å—ñ.');
                    
                    const receivedZFC = parseFloat(document.getElementById('buy_zfc_result').textContent);
                    
                    const invoiceUrl = await createStarsInvoice(transactionAmount, `–ö—É–ø—ñ–≤–ª—è ${receivedZFC.toFixed(2)} ZFC`);
                    
                    Telegram.WebApp.openInvoice(invoiceUrl, async (status) => {
                        if (status === 'paid') {
                            userBalance.zfc += receivedZFC;
                            userBalance.stars -= transactionAmount;
                            await updateFirebaseBalance(userId, userBalance);
                            messageBox.textContent = `‚úÖ –£–≥–æ–¥–∞ —É—Å–ø—ñ—à–Ω–∞! –ö—É–ø–ª–µ–Ω–æ ${receivedZFC.toFixed(2)} ZFC.`;
                        } else {
                            messageBox.textContent = `‚ùå –û–ø–ª–∞—Ç–∞ –Ω–µ –≤—ñ–¥–±—É–ª–∞—Å—è. –°—Ç–∞—Ç—É—Å: ${status}.`;
                        }
                        updateUI();
                    });

                } else if (type === 'sell') {
                    if (userBalance.zfc < transactionAmount) throw new Error(`–ù–µ–¥–æ—Å—Ç–∞—Ç–Ω—å–æ ${ZFC_NAME} –Ω–∞ –±–∞–ª–∞–Ω—Å—ñ.`);

                    const receivedStars = parseFloat(document.getElementById('sell_stars_result').textContent);
                    
                    userBalance.zfc -= transactionAmount;
                    await updateFirebaseBalance(userId, userBalance);
                    
                    userBalance.stars += receivedStars;
                    await updateFirebaseBalance(userId, userBalance); 
                    messageBox.textContent = `‚úÖ –ü—Ä–æ–¥–∞–∂ —É—Å–ø—ñ—à–Ω–∏–π! –í–∏–≤—ñ–¥ ${receivedStars.toFixed(2)} Stars —ñ–Ω—ñ—Ü—ñ–π–æ–≤–∞–Ω–æ.`;
                }

            } catch (error) {
                messageBox.textContent = `‚ùå –ü–æ–º–∏–ª–∫–∞: ${error.message}`;
            } finally {
                updateUI();
            }
        }

        initApp();
        setInterval(updateUI, 1000); 
    </script>
</body>
</html>
